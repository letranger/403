<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2023-02-27 Mon 18:02 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MariaDB Galera Cluster</title>
<meta name="author" content="Yung Chin, Yen" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" type="text/css" href="../css/muse.css" />
</head>
<body>
<div id="content" class="content">
<h1 class="title">MariaDB Galera Cluster</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org104d4a8">1. Install Ubuntu on Mac</a></li>
<li><a href="#orgb805699">2. 安裝MariaDB Galera Cluster</a>
<ul>
<li><a href="#org3344ff2">2.1. 安裝系統</a></li>
<li><a href="#org25e118e">2.2. 設定50-server.cnf</a></li>
<li><a href="#orgf875124">2.3. 設定galera.cnf</a></li>
<li><a href="#orgdbc6a42">2.4. 驗證Verify Replication</a></li>
<li><a href="#orgb0a5d5d">2.5. autostart mariadb</a></li>
</ul>
</li>
<li><a href="#orga1f52ca">3. MariaDB Galera問題處理</a>
<ul>
<li><a href="#org84d0b27">3.1. 重新啟動後,其他node無法join</a></li>
<li><a href="#org3a86e79">3.2. master無法galera_new_cluster</a></li>
</ul>
</li>
<li><a href="#orgdbb7c3e">4. 移除MariaDB</a></li>
<li><a href="#orgebce0c3">5. 架設haproxy</a>
<ul>
<li><a href="#org449d21b">5.1. 移除</a></li>
<li><a href="#orgbb44759">5.2. 安裝</a></li>
<li><a href="#orge7d80fb">5.3. 編輯haproxy.cfg</a></li>
<li><a href="#org47dfd8c">5.4. 重啟haproxy</a></li>
<li><a href="#org81efecf">5.5. 建立mysql-check user</a></li>
<li><a href="#org4e30348">5.6. 測試</a></li>
<li><a href="#orgb161e16">5.7. 架設Load Balance（HA Proxy）</a></li>
</ul>
</li>
<li><a href="#orgf6f7c83">6. 監測haproxy</a>
<ul>
<li><a href="#orgf2ed6d5">6.1. references</a></li>
<li><a href="#orgdbeda09">6.2. 大量加入mysql資料</a></li>
<li><a href="#orgeeadf77">6.3. 被監控端</a></li>
<li><a href="#org2541caf">6.4. 把node_exporter改為service自動執行</a></li>
<li><a href="#org0c73ffb">6.5. 把mysqld_exporter改為service自動執行</a></li>
</ul>
</li>
<li><a href="#org5f7bae4">7. Prometheus</a>
<ul>
<li><a href="#orgc702f15">7.1. 把node_exporter改為service自動執行</a></li>
</ul>
</li>
<li><a href="#org3f92a58">8. phpmyadmin</a></li>
<li><a href="#org1b553ab">9. 403 server List</a></li>
<li><a href="#orgfce8b53">10. Nginx v.s. Moodle</a>
<ul>
<li><a href="#org1669dff">10.1. 移除套件</a></li>
<li><a href="#org0857cba">10.2. 安裝套件</a></li>
<li><a href="#orgc9030ee">10.3. 編輯php.ini</a></li>
<li><a href="#org3866fb9">10.4. 安裝Moodle</a></li>
</ul>
</li>
<li><a href="#org0773e0b">11. Docker commands</a>
<ul>
<li><a href="#org2fe45ef">11.1. List comtainer</a></li>
<li><a href="#orgc6f9efa">11.2. commit</a></li>
<li><a href="#org747648b">11.3. run</a></li>
<li><a href="#org0a56c0a">11.4. duplicate</a></li>
</ul>
</li>
<li><a href="#orgabf1f2f">12. References</a></li>
</ul>
</div>
</div>
<a href="https://hits.sh/letranger.github.io/403/dbCluster.html/"><img align="right" alt="Hits" src="https://hits.sh/letranger.github.io/403/dbCluster.html.svg?style=plastic"/></a>

<div id="outline-container-org104d4a8" class="outline-2">
<h2 id="org104d4a8"><span class="section-number-2">1.</span> Install Ubuntu on Mac</h2>
<div class="outline-text-2" id="text-1">
<ol class="org-ol">
<li>Download Ubuntu ISO</li>
<li>Open Disk Utility, Create 1 Partition to Mac OS Extended (Journaled) for USB Stick.</li>
<li>Click the <b>Options</b> Button and ensure that GUID Partition Table is selected and then click OK.</li>
<li>Open Terminal and enter the following commands
<ol class="org-ol">
<li><p>
Convert ISO to IMG
</p>
<div class="org-src-container">
<pre class="src src-shell">hdiutil convert -format UDRW -o ~/path/to/target.img ~/path/to/ubuntu.iso
</pre>
</div></li>
<li><p>
Find USB disk Number and unmount it
</p>
<div class="org-src-container">
<pre class="src src-shell">diskutil list
diskutil unmountDisk /dev/diskN
</pre>
</div></li>
<li><p>
Create bootable USB
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #ECBE7B;">sudo</span> dd <span style="color: #dcaeea;">if</span>=/path/to/downloaded.img <span style="color: #dcaeea;">of</span>=/dev/diskN <span style="color: #dcaeea;">bs</span>=1m
</pre>
</div></li>
<li>Install</li>
</ol></li>
</ol>
</div>
</div>
<div id="outline-container-orgb805699" class="outline-2">
<h2 id="orgb805699"><span class="section-number-2">2.</span> 安裝MariaDB Galera Cluster</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li><a href="https://cloudinfrastructureservices.co.uk/how-to-setup-mariadb-clustering-on-ubuntu-20-04/">How to Setup Mariadb Clustering on Ubuntu 20.04</a></li>
</ul>
</div>
<div id="outline-container-org3344ff2" class="outline-3">
<h3 id="org3344ff2"><span class="section-number-3">2.1.</span> 安裝系統</h3>
<div class="outline-text-3" id="text-2-1">
</div>
<div id="outline-container-orgc769c48" class="outline-4">
<h4 id="orgc769c48"><span class="section-number-4">2.1.1.</span> Installing MariaDB on ALL Nodes</h4>
<div class="outline-text-4" id="text-2-1-1">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #ECBE7B;">sudo</span> apt install mariadb-server -y
<span style="color: #ECBE7B;">sudo</span> systemctl start mariadb
<span style="color: #ECBE7B;">sudo</span> mysql_secure_installation
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org25e118e" class="outline-3">
<h3 id="org25e118e"><span class="section-number-3">2.2.</span> 設定50-server.cnf</h3>
<div class="outline-text-3" id="text-2-2">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #ECBE7B;">sudo</span> emacs /etc/mysql/mariadb.conf.d/50-server.cnf
</pre>
</div>
<p>
Comment the bind line on the file /etc/mysql/mariadb.conf.d/50-server.cnf which binds MariaDB service to 127.0.0.1
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Instead of skip-networking the default is now to listen only on</span>
<span style="color: #5B6268;">## </span><span style="color: #5B6268;">localhost which is more compatible and is not </span><span style="color: #5B6268;">less</span><span style="color: #5B6268;"> secure.</span>
<span style="color: #5B6268;">#</span><span style="color: #5B6268;">bind-address            = 127.0.0.1</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgf875124" class="outline-3">
<h3 id="orgf875124"><span class="section-number-3">2.3.</span> 設定galera.cnf</h3>
<div class="outline-text-3" id="text-2-3">
<ol class="org-ol">
<li><p>
Configuring the <b>First</b> Node
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #ECBE7B;">sudo</span> emacs /etc/mysql/conf.d/galera.cnf
</pre>
</div>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #51afef;">[</span>mysqld<span style="color: #51afef;">]</span>
<span style="color: #dcaeea;">binlog_format</span>=ROW
default-storage-engine=innodb
<span style="color: #dcaeea;">innodb_autoinc_lock_mode</span>=<span style="color: #da8548; font-weight: bold;">2</span>
<span style="color: #dcaeea;">innodb_locks_unsafe_for_binlog</span>=<span style="color: #da8548; font-weight: bold;">1</span>
<span style="color: #dcaeea;">innodb_doublewrite</span>=<span style="color: #da8548; font-weight: bold;">1</span>
<span style="color: #5B6268;">#</span><span style="color: #5B6268;">bind-address=0.0.0.0</span>

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">Galera Provider Configuration</span>
<span style="color: #dcaeea;">wsrep_on</span>=ON
<span style="color: #dcaeea;">wsrep_provider</span>=/usr/lib/galera/libgalera_smm.so

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">Galera Cluster Configuration</span>
<span style="color: #dcaeea;">wsrep_provider_options</span>=<span style="color: #98be65;">"gcache.size=256M; gcache.page_size=128M"</span>
<span style="color: #dcaeea;">wsrep_cluster_name</span>=<span style="color: #98be65;">"TNFSH_DB_Cluster"</span>
<span style="color: #dcaeea;">wsrep_cluster_address</span>=<span style="color: #98be65;">"gcomm://192.168.16.41, 192.168.16.42, 192.168.16.43, 192.168.16.44, 192.168.16.45, 192.168.16.46, 192.168.16.47, 192.168.16.48, 192.168.16.49, 192.168.16.50, 192.168.16.51, 192.168.16.52, 192.168.16.53, 192.168.16.54, 192.168.16.55, 192.168.16.56, 192.168.16.57, 192.168.16.58, 192.168.16.59"</span>

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">Galera Synchronization Configuration</span>
<span style="color: #dcaeea;">wsrep_sst_method</span>=rsync

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">Galera Node Configuration</span>
<span style="color: #dcaeea;">wsrep_node_address</span>=<span style="color: #98be65;">"192.168.16.41"</span>
<span style="color: #dcaeea;">wsrep_node_name</span>=<span style="color: #98be65;">"TNFSH_DB01"</span>

</pre>
</div></li>
<li><p>
Configuring the <b>Second</b> Node
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #ECBE7B;">sudo</span> emacs /etc/mysql/conf.d/galera.cnf
</pre>
</div>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #51afef;">[</span>mysqld<span style="color: #51afef;">]</span>
<span style="color: #dcaeea;">binlog_format</span>=ROW
default-storage-engine=innodb
<span style="color: #dcaeea;">innodb_autoinc_lock_mode</span>=<span style="color: #da8548; font-weight: bold;">2</span>
<span style="color: #dcaeea;">innodb_locks_unsafe_for_binlog</span>=<span style="color: #da8548; font-weight: bold;">1</span>
<span style="color: #dcaeea;">innodb_doublewrite</span>=<span style="color: #da8548; font-weight: bold;">1</span>
<span style="color: #5B6268;">#</span><span style="color: #5B6268;">bind-address=0.0.0.0</span>

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">Galera Provider Configuration</span>
<span style="color: #dcaeea;">wsrep_on</span>=ON
<span style="color: #dcaeea;">wsrep_provider</span>=/usr/lib/galera/libgalera_smm.so

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">Galera Cluster Configuration</span>
<span style="color: #dcaeea;">wsrep_provider_options</span>=<span style="color: #98be65;">"gcache.size=256M; gcache.page_size=128M"</span>
<span style="color: #dcaeea;">wsrep_cluster_name</span>=<span style="color: #98be65;">"TNFSH_DB_Cluster"</span>
<span style="color: #dcaeea;">wsrep_cluster_address</span>=<span style="color: #98be65;">"gcomm://192.168.16.41, 192.168.16.42, 192.168.16.43, 192.168.16.44, 192.168.16.45, 192.168.16.46, 192.168.16.47, 192.168.16.48, 192.168.16.49"</span>

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">Galera Synchronization Configuration</span>
<span style="color: #dcaeea;">wsrep_sst_method</span>=rsync

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">Galera Node Configuration</span>
<span style="color: #dcaeea;">wsrep_node_address</span>=<span style="color: #98be65;">"192.168.16.42"</span>
<span style="color: #dcaeea;">wsrep_node_name</span>=<span style="color: #98be65;">"TNFSH_DB02"</span>
</pre>
</div></li>
<li>Starting the Galera Cluster
<ol class="org-ol">
<li><p>
Stop MariaDB on ALL Nodes and make sure MariaDB service is stopped
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #ECBE7B;">sudo</span> systemctl stop mariadb
<span style="color: #ECBE7B;">sudo</span> systemctl status mariadb
</pre>
</div></li>
<li><p>
Start the <b>First</b> Node
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #ECBE7B;">sudo</span> galera_new_cluster
</pre>
</div></li>
<li><p>
Make sure the cluster status
</p>
<div class="org-src-container">
<pre class="src src-shell">mysql -u root -p -e <span style="color: #98be65;">"SHOW STATUS LIKE 'wsrep_cluster_size'"</span>
</pre>
</div></li>
<li><p>
Start the <b>Second</b> Node
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #ECBE7B;">sudo</span> systemctl start mariadb
</pre>
</div></li>
<li><p>
Make sure the cluster status
</p>
<div class="org-src-container">
<pre class="src src-shell">mysql -u root -p -e <span style="color: #98be65;">"SHOW STATUS LIKE 'wsrep_cluster_size'"</span>
</pre>
</div></li>
<li><p>
Start the <b>Third</b> Node
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #ECBE7B;">sudo</span> systemctl start mariadb
</pre>
</div></li>
<li><p>
Make sure the cluster status
</p>
<div class="org-src-container">
<pre class="src src-shell">mysql -u root -pilov1tnfsh -e <span style="color: #98be65;">"SHOW STATUS LIKE 'wsrep_cluster_size'"</span>
</pre>
</div></li>
</ol></li>
</ol>
</div>
</div>
<div id="outline-container-orgdbc6a42" class="outline-3">
<h3 id="orgdbc6a42"><span class="section-number-3">2.4.</span> 驗證Verify Replication</h3>
<div class="outline-text-3" id="text-2-4">
<ol class="org-ol">
<li><p>
Create a Database and Table on the First Node
</p>
<div class="org-src-container">
<pre class="src src-shell">mysql -u root -p
CREATE DATABASE classdb;
</pre>
</div></li>
<li><p>
Create a table named students
</p>
<div class="org-src-container">
<pre class="src src-shell">USE classdb;
CREATE TABLE students <span style="color: #51afef;">(</span>id int, name varchar<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">20</span><span style="color: #c678dd;">)</span>, surname varchar<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">20</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>;
</pre>
</div></li>
<li><p>
Insert some data into studetns table:
</p>
<div class="org-src-container">
<pre class="src src-shell">INSERT INTO students VALUES <span style="color: #51afef;">(</span>1,<span style="color: #98be65;">"&#37101;&#23567;&#22914;"</span>,<span style="color: #98be65;">"Ruby"</span><span style="color: #51afef;">)</span>;
INSERT INTO students VALUES <span style="color: #51afef;">(</span>2,<span style="color: #98be65;">"&#38991;&#23567;&#21746;"</span>,<span style="color: #98be65;">"James"</span><span style="color: #51afef;">)</span>;
INSERT INTO students VALUES <span style="color: #51afef;">(</span>3,<span style="color: #98be65;">"&#38991;&#23567;&#24070;"</span>,<span style="color: #98be65;">"Vanessa"</span><span style="color: #51afef;">)</span>;
</pre>
</div></li>
<li><p>
Verify the inserted data with the following command:
</p>
<div class="org-src-container">
<pre class="src src-shell">SELECT * FROM students;
</pre>
</div></li>
</ol>
<ol class="org-ol">
<li><p>
Verify Replication on the Second and Third Node
</p>
<div class="org-src-container">
<pre class="src src-shell">mysql -u root -p
SHOW DATABASES;
USE classdb;
SELECT * FROM students;
</pre>
</div>
<p>
Insert some data on <b>Second</b> Node
</p>
<div class="org-src-container">
<pre class="src src-shell">INSERT INTO students VALUES <span style="color: #51afef;">(</span>4,<span style="color: #98be65;">"&#38991;&#23567;&#36914;"</span>,<span style="color: #98be65;">"Letranger"</span><span style="color: #51afef;">)</span>;
</pre>
</div>
<p>
Verify on other nodes
</p></li>
</ol>
</div>
</div>
<div id="outline-container-orgb0a5d5d" class="outline-3">
<h3 id="orgb0a5d5d"><span class="section-number-3">2.5.</span> autostart mariadb</h3>
<div class="outline-text-3" id="text-2-5">
<div class="org-src-container">
<pre class="src src-shell"><span class="linenr">1: </span><span style="color: #ECBE7B;">sudo</span> update-rc.d mariadb defaults
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orga1f52ca" class="outline-2">
<h2 id="orga1f52ca"><span class="section-number-2">3.</span> MariaDB Galera問題處理</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li><a href="https://www.cnblogs.com/nulige/articles/8470001.html">問題處理 </a>太好了</li>
<li><a href="https://mariadb.com/kb/en/getting-started-with-mariadb-galera-cluster/">Getting Started with MariaDB Galera Cluster</a></li>
</ul>
</div>
<div id="outline-container-org84d0b27" class="outline-3">
<h3 id="org84d0b27"><span class="section-number-3">3.1.</span> 重新啟動後,其他node無法join</h3>
<div class="outline-text-3" id="text-3-1">
</div>
<div id="outline-container-org31e8dd3" class="outline-4">
<h4 id="org31e8dd3"><span class="section-number-4">3.1.1.</span> #1</h4>
<div class="outline-text-4" id="text-3-1-1">
<ul class="org-ul">
<li>正常第一次启动集群，使用命令：galera_new_cluster</li>
<li>整個集群關閉後，再重新啟動，則打開任一主機，輸入命令：</li>
</ul>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #ECBE7B;">sudo</span> emacs /var/lib/mysql/grastate.dat
</pre>
</div>
<p>
將seqno改為1
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #5B6268;">#</span><span style="color: #5B6268;">GALERA savedd state</span>
version:2.1
uuid: &#33258;&#24049;&#30340;cluster id
seqno: -1
safe_to_bootstrap:0
</pre>
</div>
<p>
啟動 galera_new_cluster，這是master
其他node則用systemctl start mariadb啟動
</p>
</div>
</div>
<div id="outline-container-org8706e24" class="outline-4">
<h4 id="org8706e24"><span class="section-number-4">3.1.2.</span> #2</h4>
<div class="outline-text-4" id="text-3-1-2">
</div>
<ol class="org-ol">
<li><a id="org791449f"></a>移除ib_logfile、kill process accessing the file<br />
<div class="outline-text-5" id="text-3-1-2-1">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #ECBE7B;">sudo</span> <span style="color: #ECBE7B;">rm</span> -rf /var/lib/mysql/ib_logfile*
<span style="color: #ECBE7B;">sudo</span> fuser -k 3306/tcp
</pre>
</div>
</div>
</li>
</ol>
</div>
</div>

<div id="outline-container-org3a86e79" class="outline-3">
<h3 id="org3a86e79"><span class="section-number-3">3.2.</span> master無法galera_new_cluster</h3>
<div class="outline-text-3" id="text-3-2">
<p>
狀況:
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #51afef;">[</span>db1<span style="color: #51afef;">]</span># galera_new_cluster
Job for mariadb.service failed because the control process exited with error code.
See <span style="color: #98be65;">"systemctl status mariadb.service"</span> and <span style="color: #98be65;">"journalctl -xe"</span> for details.
</pre>
</div>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #ECBE7B;">sudo</span> emacs /var/lib/mysql/grastate.dat
</pre>
</div>
<p>
將safe_to_bootstrap改為1
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #5B6268;">#</span><span style="color: #5B6268;">GALERA savedd state</span>
version:2.1
uuid: &#33258;&#24049;&#30340;cluster id
seqno: -1
safe_to_bootstrap:0
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgdbb7c3e" class="outline-2">
<h2 id="orgdbb7c3e"><span class="section-number-2">4.</span> 移除MariaDB</h2>
<div class="outline-text-2" id="text-4">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #ECBE7B;">sudo</span> systemctl stop mariadb
<span style="color: #ECBE7B;">sudo</span> apt remove <span style="color: #98be65;">'mariadb*'</span> -y
<span style="color: #ECBE7B;">sudo</span> apt purge <span style="color: #98be65;">'mariadb*'</span> -y
<span style="color: #ECBE7B;">sudo</span> apt remove <span style="color: #98be65;">'mysql*'</span> -y
<span style="color: #ECBE7B;">sudo</span> apt purge <span style="color: #98be65;">'mysql*'</span> -y
<span style="color: #ECBE7B;">sudo</span> apt autoremove -y
<span style="color: #ECBE7B;">sudo</span> apt autoclean -y
<span style="color: #ECBE7B;">sudo</span> apt update -y
<span style="color: #ECBE7B;">sudo</span> apt upgrade -y
<span style="color: #ECBE7B;">sudo</span> apt autoremove
<span style="color: #ECBE7B;">sudo</span> apt-get --fix-broken install
<span style="color: #ECBE7B;">sudo</span> <span style="color: #ECBE7B;">rm</span> -rf /etc/mysql /var/lib/mysql
<span style="color: #ECBE7B;">sudo</span> reboot
</pre>
</div>
</div>
</div>
<div id="outline-container-orgebce0c3" class="outline-2">
<h2 id="orgebce0c3"><span class="section-number-2">5.</span> 架設haproxy</h2>
<div class="outline-text-2" id="text-5">
<ul class="org-ul">
<li><a href="https://gary840227.medium.com/mariadb-cluster-f7220e9eaac8">如何建置 MariaDb Galera Cluster</a></li>
</ul>
</div>
<div id="outline-container-org449d21b" class="outline-3">
<h3 id="org449d21b"><span class="section-number-3">5.1.</span> 移除</h3>
<div class="outline-text-3" id="text-5-1">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #ECBE7B;">sudo</span> apt remove haproxy -y
<span style="color: #ECBE7B;">sudo</span> apt purge haproxy -y
<span style="color: #ECBE7B;">sudo</span> apt autoclean -y
<span style="color: #ECBE7B;">sudo</span> apt autoremove -y
<span style="color: #ECBE7B;">sudo</span> <span style="color: #ECBE7B;">rm</span> -rf /etc/haproxy
</pre>
</div>
</div>
</div>
<div id="outline-container-orgbb44759" class="outline-3">
<h3 id="orgbb44759"><span class="section-number-3">5.2.</span> 安裝</h3>
<div class="outline-text-3" id="text-5-2">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #ECBE7B;">sudo</span> apt install haproxy -y
</pre>
</div>
</div>
</div>
<div id="outline-container-orge7d80fb" class="outline-3">
<h3 id="orge7d80fb"><span class="section-number-3">5.3.</span> 編輯haproxy.cfg</h3>
<div class="outline-text-3" id="text-5-3">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #ECBE7B;">sudo</span> emacs /etc/haproxy/haproxy.cfg
</pre>
</div>
<p>
內容如下:
</p>
<div class="org-src-container">
<pre class="src src-shell">global
         <span style="color: #5B6268;"># </span><span style="color: #5B6268;">log required rsyslog         log /dev/log    local0</span>
        <span style="color: #c678dd;">log</span> /dev/log    local1 notice
        chroot /var/lib/haproxy
        stats socket /run/haproxy/admin.sock mode <span style="color: #da8548; font-weight: bold;">660</span> level admin expose-fd listeners
        stats timeout 30s        <span style="color: #5B6268;"># </span><span style="color: #5B6268;">user and group will be run as</span>
        user haproxy
        group haproxy
        daemon

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">Default SSL material locations</span>
        ca-base /etc/ssl/certs
        crt-base /etc/ssl/private

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">Default ciphers to use on SSL-enabled listening sockets.</span>
<span style="color: #5B6268;"># </span><span style="color: #5B6268;">For more information, see ciphers(1SSL). This list is from:</span>
<span style="color: #5B6268;">#  </span><span style="color: #5B6268;">https://hynek.me/articles/hardening-your-web-servers-ssl-ciphers/</span>
<span style="color: #5B6268;"># </span><span style="color: #5B6268;">An alternative list with additional directives can be obtained from https://mozilla.github.io/server-side-tls/ssl-config-generator/?server=haproxyssl-default-bind-ciphersECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:RSA+AESGCM:RSA+AES:!aNULL:!MD5:!DSSssl-default-bind-options no-sslv3</span>
defaults
        <span style="color: #c678dd;">log</span>     global
        mode    http
        option  httplog
        option  dontlognull
        timeout connect <span style="color: #da8548; font-weight: bold;">5000</span>
        timeout client  <span style="color: #da8548; font-weight: bold;">50000</span>
        timeout server  <span style="color: #da8548; font-weight: bold;">50000</span>
        errorfile <span style="color: #da8548; font-weight: bold;">400</span> /etc/haproxy/errors/400.http
        errorfile <span style="color: #da8548; font-weight: bold;">403</span> /etc/haproxy/errors/403.http
        errorfile <span style="color: #da8548; font-weight: bold;">408</span> /etc/haproxy/errors/408.http
        errorfile <span style="color: #da8548; font-weight: bold;">500</span> /etc/haproxy/errors/500.http
        errorfile <span style="color: #da8548; font-weight: bold;">502</span> /etc/haproxy/errors/502.http
        errorfile <span style="color: #da8548; font-weight: bold;">503</span> /etc/haproxy/errors/503.http
        errorfile <span style="color: #da8548; font-weight: bold;">504</span> /etc/haproxy/errors/504.http

listen galera
    bind 192.168.16.40:3306
    balance roundrobin <span style="color: #5B6268;">#  </span><span style="color: #5B6268;">load balancer policy</span>
    mode tcp <span style="color: #5B6268;"># </span><span style="color: #5B6268;">(tcp &#35373;&#32622;&#28858; layer 7 , http &#28858; layer 4)</span>
    option tcpka <span style="color: #5B6268;"># </span><span style="color: #5B6268;">enable keepalive to maintain tcp connection</span>
    option mysql-check user haproxy <span style="color: #5B6268;"># </span><span style="color: #5B6268;">enable database server check</span>
    server TNFSH_DB01 192.168.16.41:3306 check weight <span style="color: #da8548; font-weight: bold;">1</span>
    server TNFSH_DB02 192.168.16.42:3306 check weight <span style="color: #da8548; font-weight: bold;">1</span>
    server TNFSH_DB03 192.168.16.43:3306 check weight <span style="color: #da8548; font-weight: bold;">1</span>
    server TNFSH_DB04 192.168.16.44:3306 check weight <span style="color: #da8548; font-weight: bold;">1</span>
    server TNFSH_DB05 192.168.16.45:3306 check weight <span style="color: #da8548; font-weight: bold;">1</span>

listen stats
   bind 0.0.0.0:9000
   mode http
   stats enable <span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#21855;&#29992;&#29376;&#24907;</span>
   stats uri /stats   <span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#32178;&#22336;&#36335;&#24465;</span>
   stats realm HAProxy<span style="color: #98be65;">\ </span>Statistics
   stats auth howtoforge:howtoforge <span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#35373;&#23450;&#24115;&#34399;&#23494;&#30908;</span>
   stats admin if TRUE <span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#35373;&#23450;&#20351;&#29992;&#32773;&#30331;&#20837;&#24460;&#28858;&#31649;&#29702;&#32773;</span>
   stats refresh 30s <span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#27599; 30 &#31186;&#21047;&#26032;&#30435;&#25511;&#30059;&#38754;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org47dfd8c" class="outline-3">
<h3 id="org47dfd8c"><span class="section-number-3">5.4.</span> 重啟haproxy</h3>
<div class="outline-text-3" id="text-5-4">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #ECBE7B;">sudo</span> systemctl restart haproxy
</pre>
</div>
<p>
觀察 <a href="http://192.168.16.40:9000/stats">http://192.168.16.40:9000/stats</a>
帳密: howtoforge / howtoforge
</p>
</div>
</div>
<div id="outline-container-org81efecf" class="outline-3">
<h3 id="org81efecf"><span class="section-number-3">5.5.</span> 建立mysql-check user</h3>
<div class="outline-text-3" id="text-5-5">
<p>
於任一node
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #ECBE7B;">sudo</span> mysql -u root -pilov1tnfsh
create user <span style="color: #98be65;">'haproxy'</span>@<span style="color: #98be65;">'192.168.16.40'</span>; <span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#24115;&#34399;@ip</span>
flush privileges;
</pre>
</div>
</div>
</div>
<div id="outline-container-org4e30348" class="outline-3">
<h3 id="org4e30348"><span class="section-number-3">5.6.</span> 測試</h3>
<div class="outline-text-3" id="text-5-6">
<p>
測試 haproxy 是否將我們導向不同的 mariadb , 我們對每個節點的 mariadb 設定專屬的 server-id
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #ECBE7B;">sudo</span> mysql -h192.168.16.40 -uroot -pilov1tnfsh -e <span style="color: #98be65;">"SET GLOBAL server_id=161"</span>
<span style="color: #ECBE7B;">sudo</span> mysql -h192.168.16.40 -uroot -pilov1tnfsh -e <span style="color: #98be65;">"SET GLOBAL server_id=162"</span>
<span style="color: #ECBE7B;">sudo</span> mysql -h192.168.16.40 -uroot -pilov1tnfsh -e <span style="color: #98be65;">"SET GLOBAL server_id=163"</span>
<span style="color: #ECBE7B;">sudo</span> mysql -h192.168.16.40 -uroot -pilov1tnfsh -e <span style="color: #98be65;">"SET GLOBAL server_id=164"</span>
<span style="color: #ECBE7B;">sudo</span> mysql -h192.168.16.40 -uroot -pilov1tnfsh -e <span style="color: #98be65;">"SET GLOBAL server_id=165"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgb161e16" class="outline-3">
<h3 id="orgb161e16"><span class="section-number-3">5.7.</span> 架設Load Balance（HA Proxy）</h3>
<div class="outline-text-3" id="text-5-7">
<ol class="org-ol">
<li><p>
關閉防火牆
</p>
<div class="org-src-container">
<pre class="src src-shell">   <span style="color: #ECBE7B;">sudo</span> ufw disable
   <span style="color: #ECBE7B;">sudo</span> ufw status
</pre>
</div></li>
<li><p>
安裝HA Proxy
</p>
<div class="org-src-container">
<pre class="src src-shell">   <span style="color: #ECBE7B;">sudo</span> apt install haproxy
</pre>
</div></li>
<li>建立與設定clustercheck
<ol class="org-ol">
<li><p>
於MariaDB 所有Nodes下載並設定clustercheck，將檔案放在/usr/bin下，設定可執行權限
</p>
<div class="org-src-container">
<pre class="src src-shell">      <span style="color: #ECBE7B;">git</span> clone https://github.com/olafz/percona-clustercheck
      <span style="color: #ECBE7B;">cd</span> percona-clustercheck
      <span style="color: #ECBE7B;">cd</span> clustercheck
      <span style="color: #ECBE7B;">chmod</span> <span style="color: #da8548; font-weight: bold;">755</span> clustercheck
      <span style="color: #ECBE7B;">sudo</span> <span style="color: #ECBE7B;">mv</span> clustercheck /usr/bin
      <span style="color: #ECBE7B;">ls</span> -al /usr/bin/clustercheck
</pre>
</div></li>
<li><p>
為clustercheck建一組檢查用的mysql帳號
</p>
<div class="org-src-container">
<pre class="src src-shell">mysql -u root -p
GRANT PROCESS ON *.* TO <span style="color: #98be65;">'clustercheckuser'</span>@<span style="color: #98be65;">'localhost'</span> IDENTIFIED BY <span style="color: #98be65;">'clustercheckpassword!'</span> ;
FLUSH PRIVILEGES;
</pre>
</div></li>
</ol></li>
<li>於MariaDB所有Nodes安裝與設定xinetd
讓clustercheck可以透過網路執行
<ol class="org-ol">
<li><p>
安裝xinetd
</p>
<div class="org-src-container">
<pre class="src src-shell">      <span style="color: #ECBE7B;">sudo</span> apt install xinetd
</pre>
</div></li>
<li><p>
設定xinetd
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #ECBE7B;">sudo</span> emacs /etc/xinetd.d/mysqlchk
</pre>
</div>
<p>
內容:
</p>
<div class="org-src-container">
<pre class="src src-shell">      <span style="color: #5B6268;"># </span><span style="color: #5B6268;">default: on</span>
      <span style="color: #5B6268;"># </span><span style="color: #5B6268;">description: mysqlchk</span>
      service mysqlchk
      <span style="color: #51afef;">{</span>
             <span style="color: #dcaeea;">disable</span> = no
             <span style="color: #dcaeea;">flags</span> = REUSE
             <span style="color: #dcaeea;">socket_type</span> = stream
             <span style="color: #dcaeea;">port</span> = <span style="color: #da8548; font-weight: bold;">9200</span>
             <span style="color: #dcaeea;">wait</span> = no
             <span style="color: #dcaeea;">user</span> = nobody
             <span style="color: #dcaeea;">server</span> = /usr/bin/clustercheck
             <span style="color: #dcaeea;">log_on_failure</span> += USERID
             <span style="color: #dcaeea;">only_from</span> = 0.0.0.0/0
             <span style="color: #dcaeea;">per_source</span> = UNLIMITED
      <span style="color: #51afef;">}</span>
</pre>
</div></li>
<li><p>
調整services
在上方中，我們設定了9200來當我們觸發xinetd的Port，所以要在/etc/services裡做一下調整，編輯 /etc/services來調整，取消原本的9200，加入我們新增的mysqlchk
</p>
<div class="org-src-container">
<pre class="src src-shell">      mysqlchk        9200/tcp                        <span style="color: #5B6268;">#</span><span style="color: #5B6268;">Galera Clustercheck</span>
</pre>
</div></li>
<li><p>
啟動xinetd
</p>
<div class="org-src-container">
<pre class="src src-shell">      <span style="color: #ECBE7B;">sudo</span> /etc/init.d/xinetd start
</pre>
</div></li>
<li><p>
設定xinetd重啟動後自動啟動
</p>
<div class="org-src-container">
<pre class="src src-shell">      <span style="color: #ECBE7B;">sudo</span> pdate-rc.d xinetd defaults
</pre>
</div>
<p>
server TNFSH_DB03 192.168.16.43:3306 check port 9200 weight 1
server TNFSH_DB04 192.168.16.44:3306 check port 9200 weight 1
server TNFSH_DB05 192.168.16.45:3306 check port 9200 weight 1
</p></li>
<li><p>
測試
</p>
<div class="org-src-container">
<pre class="src src-shell">      telnet localhost <span style="color: #da8548; font-weight: bold;">9200</span>
</pre>
</div>
<p>
結果
</p>
<div class="org-src-container">
<pre class="src src-shell">      Trying 127.0.0.1...
      Connected to localhost.
      Escape character is <span style="color: #98be65;">'^]'</span>.
      HTTP/1.1 <span style="color: #da8548; font-weight: bold;">503</span> Service Unavailable
      Content-Type: text/plain
      Connection: close
      Content-Length: <span style="color: #da8548; font-weight: bold;">44</span>

      Percona XtraDB Cluster Node is not synced.
      Connection closed by foreign host.
</pre>
</div></li>
</ol></li>

<li><p>
Install the latest HAProxy using a PPA
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #ECBE7B;">sudo</span> apt install --no-install-recommends software-properties-common
<span style="color: #ECBE7B;">sudo</span> add-apt-repository ppa:vbernat/haproxy-2.4 -y
<span style="color: #ECBE7B;">sudo</span> apt install <span style="color: #dcaeea;">haproxy</span>=2.4.<span style="color: #98be65;">\*</span>
</pre>
</div></li>
<li><p>
Update and upgrade
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #ECBE7B;">sudo</span> apt update
<span style="color: #ECBE7B;">sudo</span> apt upgrade -y
</pre>
</div></li>
<li>設定HA Proxy
<ol class="org-ol">
<li>編輯/etc/haproxy/haproxy.cfg</li>
<li>刪除原本內容</li>
<li><p>
加入
</p>
<div class="org-src-container">
<pre class="src src-shell">global
       <span style="color: #c678dd;">log</span> 127.0.0.1   local0
       <span style="color: #c678dd;">log</span> 127.0.0.1   local1 notice
       maxconn <span style="color: #da8548; font-weight: bold;">1024</span>
       user haproxy
       group haproxy
       daemon
defaults
       <span style="color: #c678dd;">log</span>     global
       mode    http
       option  tcplog
       option  dontlognull
       retries <span style="color: #da8548; font-weight: bold;">3</span>
       option  redispatch
       maxconn <span style="color: #da8548; font-weight: bold;">1024</span>
       timeout connect 5000ms
       timeout client 50000ms
       timeout server 50000ms
listen mariadb_cluster_writes 0.0.0.0:13304
<span style="color: #5B6268;">## </span><span style="color: #5B6268;">A failover pool for writes to ensure writes only hit one node at a time.</span>
       mode tcp
       option httpchk
       server galera-node01 192.168.16.41:3306 check port <span style="color: #da8548; font-weight: bold;">9200</span>
       server galera-node02 192.168.16.42:3306 check port <span style="color: #da8548; font-weight: bold;">9200</span> backup
listen mariadb_cluster_reads 0.0.0.0:13305
<span style="color: #5B6268;">## </span><span style="color: #5B6268;">A load-balanced pool for reads to utilize all nodes for reads.</span>
       mode tcp
       balance leastconn
       option httpchk
       server galera-node01 192.168.16.41:3306 check port <span style="color: #da8548; font-weight: bold;">9200</span>
       server galera-node02 192.168.16.42:3306 check port <span style="color: #da8548; font-weight: bold;">9200</span>
listen stats 0.0.0.0:9000
<span style="color: #5B6268;">## </span><span style="color: #5B6268;">HAProxy stats web gui.</span>
       mode http
       stats enable
       stats uri /haproxy_status
       stats realm HAProxy<span style="color: #98be65;">\ </span>Statistics
       stats auth haproxy:haproxy
       stats admin if TRUE
</pre>
</div></li>
</ol></li>
<li><p>
內容說明
</p>
<ol class="org-ol">
<li>Writer connection（寫入連線）：寫入連線要保持在同一台，也就是說不管有幾台機器連透過「寫入連線」的方式連入時，都要導到同一台機器；不過當機器有問題時，也能夠進行failover，下方大概解釋一下設定。
<ul class="org-ul">
<li>listen mariadb_cluster_writes 0.0.0.0:13304
說明：宣告監聽(listen)，名稱為mariadb_cluster_writes，開放任意IP連入13304 Port(0.0.0.0:13304)。</li>
<li>mode tcp
說明：使用tcp或http方式連入，這邊設定是tcp。</li>
<li>option httpchk
說明：HA Proxy在確認後方的資料庫時，透過HTTP方式來判斷後端是否正常。</li>
<li>server galera-node01 192.168.43.101:3306 check port 9200
說明：宣告server，server的暱稱為 galera-node01，實稱上的IP與Port是 192.168.43.101:3306，確認正常與否的Port是9200。</li>
<li>server galera-node02 192.168.43.102:3306 check port 9200 backup
說明：基本上與d是一樣的，不過最後多了一個backup，意思是當正常的機器有問題時，才將連線導至這一台server，如果沒有這個backup的話，HA Proxy會實行分流，可能會導到不同的server，請注意。</li>
</ul></li>
<li>Read connection（讀取連線）：讀取時不導到特定一台機器，只是單純實行Load Balance功能，這邊的設定跟讀取的設定有三點不太一樣，說明如下：
<ul class="org-ul">
<li>listen mariadb_cluster_writes 0.0.0.0:13305
說明：我們在Read connection中設定13305的Port。</li>
<li>balance leastconn
說明：分流的方式之一，將使用者導到最少人連線的server。</li>
<li>server無backup說定
說明：因為server中無backup的設定，所以會實作分流。</li>
</ul></li>
<li>網頁監看：這一個設定只是單純讓使用者在網頁上可以看到MariaDB的狀態。
<ul class="org-ul">
<li>listen stats 0.0.0.0:9000
說明：宣告監聽(listen)，名稱為stats ，開放任意IP連入9000 Port(0.0.0.0:9000)。</li>
<li>mode http
說明：使用tcp或http方式連入，這邊設定是http。</li>
<li>stats enable
說明：設定狀態為啟用。</li>
<li>stats uri /haproxy_status
說明：設定HTTP的URL，所以我們等一下要連入的網址是<a href="http://ip:9000/haproxy_status">http://ip:9000/haproxy_status</a>。</li>
<li>stats realm HAProxy\ Statistics
說明：設定使用者連線時，在輸入帳號密碼的視窗標題，通常會搭配下方的stats auth設定使用。</li>
<li>stats auth haproxy:haproxy
說明：設定使用者連線時的帳號密碼。</li>
<li>stats admin if TRUE
說明：設定使用者連線後的角色為管理員角色；管理員與一般使用者的差別在於－管理員角色有權限在網頁上針對HA Proxy上管理的伺服器做一些動作。</li>
</ul></li>
</ol>
<ol class="org-ol">
<li><p>
啟動與測試HA Proxy
</p>
<div class="org-src-container">
<pre class="src src-shell">service haproxy start
</pre>
</div></li>
</ol></li>
</ol>
</div>
</div>
</div>
<div id="outline-container-orgf6f7c83" class="outline-2">
<h2 id="orgf6f7c83"><span class="section-number-2">6.</span> 監測haproxy</h2>
<div class="outline-text-2" id="text-6">
</div>
<div id="outline-container-orgf2ed6d5" class="outline-3">
<h3 id="orgf2ed6d5"><span class="section-number-3">6.1.</span> references</h3>
<div class="outline-text-3" id="text-6-1">
<ul class="org-ul">
<li><a href="https://codertw.com/%E4%BC%BA%E6%9C%8D%E5%99%A8/144308/">使用Prometheus Grafana監控MySQL實踐</a></li>
<li><a href="https://www.gushiciku.cn/pl/p9ZR/zh-tw">Prometheus+Grafana 基礎及簡單搭建</a></li>
<li><a href="https://www.lisenet.com/2021/monitor-haproxy-with-grafana-and-prometheus-haproxy_exporter/">Monitor HAProxy with Grafana and Prometheus (haproxy_exporter)</a></li>
<li><a href="https://ithelp.ithome.com.tw/articles/10209805">[Day 30] Prometheus &amp; Intermission </a></li>
</ul>
</div>
</div>
<div id="outline-container-orgdbeda09" class="outline-3">
<h3 id="orgdbeda09"><span class="section-number-3">6.2.</span> 大量加入mysql資料</h3>
<div class="outline-text-3" id="text-6-2">
<div class="org-src-container">
<pre class="src src-shell">CREATE TABLE <span style="color: #51afef; font-weight: bold;">`data3`</span>
<span style="color: #51afef;">(</span>
  <span style="color: #51afef; font-weight: bold;">`id`</span>         bigint<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">20</span><span style="color: #c678dd;">)</span> NOT NULL      AUTO_INCREMENT,
  <span style="color: #51afef; font-weight: bold;">`datetime`</span>   timestamp  NULL          DEFAULT CURRENT_TIMESTAMP,
  <span style="color: #51afef; font-weight: bold;">`channel`</span>    int<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">11</span><span style="color: #c678dd;">)</span>                  DEFAULT NULL,
  <span style="color: #51afef; font-weight: bold;">`value`</span>      float                    DEFAULT NULL,

  PRIMARY KEY <span style="color: #c678dd;">(</span><span style="color: #51afef; font-weight: bold;">`id`</span><span style="color: #c678dd;">)</span>
<span style="color: #51afef;">)</span>;


DELIMITER $<span style="color: #dcaeea;">$</span>
CREATE PROCEDURE generate_data3<span style="color: #51afef;">()</span>
BEGIN
  DECLARE i INT DEFAULT <span style="color: #da8548; font-weight: bold;">0</span>;
  WHILE i &lt; <span style="color: #da8548; font-weight: bold;">500000</span> DO
    INSERT INTO <span style="color: #51afef; font-weight: bold;">`data3`</span> <span style="color: #51afef;">(</span><span style="color: #51afef; font-weight: bold;">`datetime`</span>,<span style="color: #51afef; font-weight: bold;">`value`</span>,<span style="color: #51afef; font-weight: bold;">`channel`</span><span style="color: #51afef;">)</span> VALUES <span style="color: #51afef;">(</span>
      FROM_UNIXTIME<span style="color: #c678dd;">(</span>UNIX_TIMESTAMP<span style="color: #98be65;">(</span><span style="color: #98be65;">'2014-01-01 01:00:00'</span><span style="color: #98be65;">)</span>+FLOOR<span style="color: #98be65;">(</span>RAND<span style="color: #a9a1e1;">()</span>*31536000<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>,
      ROUND<span style="color: #c678dd;">(</span>RAND<span style="color: #98be65;">()</span>*100,2<span style="color: #c678dd;">)</span>,
      <span style="color: #da8548; font-weight: bold;">1</span>
    <span style="color: #51afef;">)</span>;
    SET <span style="color: #dcaeea;">i</span> = i + <span style="color: #da8548; font-weight: bold;">1</span>;
  END WHILE;
END$<span style="color: #dcaeea;">$</span>
DELIMITER ;

CALL generate_data3<span style="color: #51afef;">()</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-orgeeadf77" class="outline-3">
<h3 id="orgeeadf77"><span class="section-number-3">6.3.</span> 被監控端</h3>
<div class="outline-text-3" id="text-6-3">
<ol class="org-ol">
<li>install go</li>
<li>download node_exporter</li>
<li>解壓至/usr/local</li>
<li>執行node_exporter</li>
<li>download mysqld_exporter</li>
<li>解壓至/usr/local</li>
<li>編輯.my.cnf</li>
<li>執行mysqld_exporter</li>
</ol>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #51afef;">[</span>client<span style="color: #51afef;">]</span>
<span style="color: #dcaeea;">user</span>=root
<span style="color: #dcaeea;">password</span>=ilov1tnfsh
</pre>
</div>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #ECBE7B;">cd</span> ~
<span style="color: #ECBE7B;">sudo</span> snap install go --classic
wget https://github.com/prometheus/node_exporter/releases/download/v0.14.0/node_exporter-0.14.0.linux-amd64.tar.gz
<span style="color: #ECBE7B;">sudo</span>  tar xvf node_exporter-0.14.0.linux-amd64.tar.gz -C /usr/local/
nohup /usr/local/node_exporter-0.14.0.linux-amd64/node_exporter &amp;
wget https://github.com/prometheus/mysqld_exporter/releases/download/v0.10.0/mysqld_exporter-0.10.0.linux-amd64.tar.gz
<span style="color: #ECBE7B;">sudo</span> tar xvf mysqld_exporter-0.10.0.linux-amd64.tar.gz -C /usr/local/
<span style="color: #ECBE7B;">sudo</span> emacs /usr/local/mysqld_exporter-0.10.0.linux-amd64/.my.cnf
/usr/local/mysqld_exporter-0.10.0.linux-amd64/mysqld_exporter -config.my-cnf=<span style="color: #98be65;">"/usr/local/mysqld_exporter-0.10.0.linux-amd64/.my.cnf"</span> &amp;
</pre>
</div>
</div>
</div>
<div id="outline-container-org2541caf" class="outline-3">
<h3 id="org2541caf"><span class="section-number-3">6.4.</span> 把node_exporter改為service自動執行</h3>
<div class="outline-text-3" id="text-6-4">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #51afef;">[</span>Unit<span style="color: #51afef;">]</span>
<span style="color: #dcaeea;">Description</span>=Prometheus Node Exporter
<span style="color: #dcaeea;">After</span>=network.target
<span style="color: #dcaeea;">User</span>=prometheus
<span style="color: #dcaeea;">Group</span>=prometheus

<span style="color: #51afef;">[</span>Service<span style="color: #51afef;">]</span>
<span style="color: #dcaeea;">Type</span>=simple
<span style="color: #dcaeea;">Restart</span>=always
<span style="color: #dcaeea;">ExecStart</span>=nohup /usr/local/node_exporter-0.14.0.linux-amd64/node_exporter &amp;

<span style="color: #51afef;">[</span>Install<span style="color: #51afef;">]</span>
<span style="color: #dcaeea;">WantedBy</span>=multi-user.target

</pre>
</div>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #ECBE7B;">sudo</span> emacs /etc/systemd/system/node_exporter.service
<span style="color: #ECBE7B;">sudo</span> systemctl daemon-reload
<span style="color: #ECBE7B;">sudo</span> systemctl enable node_exporter
<span style="color: #ECBE7B;">sudo</span> systemctl start node_exporter
</pre>
</div>
</div>
</div>
<div id="outline-container-org0c73ffb" class="outline-3">
<h3 id="org0c73ffb"><span class="section-number-3">6.5.</span> 把mysqld_exporter改為service自動執行</h3>
<div class="outline-text-3" id="text-6-5">
<p>
<a href="https://computingforgeeks.com/install-and-configure-prometheus-mysql-exporter-on-ubuntu-centos/">https://computingforgeeks.com/install-and-configure-prometheus-mysql-exporter-on-ubuntu-centos/</a>
mysql_exporter.service
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #51afef;">[</span>Unit<span style="color: #51afef;">]</span>
<span style="color: #dcaeea;">Description</span>=Prometheus MySQL Exporter
<span style="color: #dcaeea;">After</span>=network.target
<span style="color: #dcaeea;">User</span>=prometheus
<span style="color: #dcaeea;">Group</span>=prometheus

<span style="color: #51afef;">[</span>Service<span style="color: #51afef;">]</span>
<span style="color: #dcaeea;">Type</span>=simple
<span style="color: #dcaeea;">Restart</span>=always
<span style="color: #dcaeea;">ExecStart</span>=/usr/local/mysqld_exporter-0.10.0.linux-amd64/mysqld_exporter -config.my-cnf=<span style="color: #98be65;">"/usr/local/mysqld_exporter-0.10.0.linux-amd64/.my.cnf"</span>

<span style="color: #51afef;">[</span>Install<span style="color: #51afef;">]</span>
<span style="color: #dcaeea;">WantedBy</span>=multi-user.target

</pre>
</div>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #ECBE7B;">sudo</span> emacs /etc/systemd/system/mysqld_exporter.service
<span style="color: #ECBE7B;">sudo</span> systemctl daemon-reload
<span style="color: #ECBE7B;">sudo</span> systemctl enable mysqld_exporter
<span style="color: #ECBE7B;">sudo</span> systemctl start mysqld_exporter
</pre>
</div>
<p>
安泰 112 2 5 綁約日期
409922  剩餘本金
2.45    目前利率
8000    違約金
月付金不超過2倍，一個月可以還，
</p>

<p>
富邦的每月還款是由台新自動扣款，不要匯到富邦，匯到台新去扣
</p>
</div>
</div>
</div>
<div id="outline-container-org5f7bae4" class="outline-2">
<h2 id="org5f7bae4"><span class="section-number-2">7.</span> Prometheus</h2>
<div class="outline-text-2" id="text-7">
</div>
<div id="outline-container-orgc702f15" class="outline-3">
<h3 id="orgc702f15"><span class="section-number-3">7.1.</span> 把node_exporter改為service自動執行</h3>
<div class="outline-text-3" id="text-7-1">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #51afef;">[</span>Unit<span style="color: #51afef;">]</span>
<span style="color: #dcaeea;">Description</span>=Prometheus Node Exporter
<span style="color: #dcaeea;">After</span>=network.target
<span style="color: #dcaeea;">User</span>=prometheus
<span style="color: #dcaeea;">Group</span>=prometheus

<span style="color: #51afef;">[</span>Service<span style="color: #51afef;">]</span>
<span style="color: #dcaeea;">Type</span>=simple
<span style="color: #dcaeea;">Restart</span>=always
<span style="color: #dcaeea;">ExecStart</span>=nohup /usr/local/node_exporter-0.14.0.linux-amd64/node_exporter &amp;

<span style="color: #51afef;">[</span>Install<span style="color: #51afef;">]</span>
<span style="color: #dcaeea;">WantedBy</span>=multi-user.target

</pre>
</div>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #ECBE7B;">sudo</span> emacs /etc/systemd/system/node_exporter.service
<span style="color: #ECBE7B;">sudo</span> systemctl daemon-reload
<span style="color: #ECBE7B;">sudo</span> systemctl enable node_exporter
<span style="color: #ECBE7B;">sudo</span> systemctl start node_exporter
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org3f92a58" class="outline-2">
<h2 id="org3f92a58"><span class="section-number-2">8.</span> phpmyadmin</h2>
<div class="outline-text-2" id="text-8">
<ul class="org-ul">
<li><a href="https://www.webteach.tw/?p=3347">[ Phpmyadmin ] – 透過 Phpmyadmin 一次管理多台遠端資料庫</a></li>
<li><a href="https://lucas-yang.vercel.app/post/local-phpmyadmin-connect-to-remote-mysql/">使用本地 phpMyAdmin 連線到遠端 MySQL 資料庫</a></li>
<li><a href="https://www.itread01.com/content/1542887646.html">配置phpmyadmin連線遠端 MySQL資料庫</a></li>
</ul>
</div>
</div>

<div id="outline-container-org1b553ab" class="outline-2">
<h2 id="org1b553ab"><span class="section-number-2">9.</span> 403 server List</h2>
<div class="outline-text-2" id="text-9">
<ul class="org-ul">
<li>192.168.16.60: Prometheus</li>
<li>192.168.16.61: Galera mamanger</li>
<li>192.168.16.40: haproxy server</li>
<li>192.168.16.41: db01</li>
<li>192.168.16.42: db02</li>
<li>192.168.16.43: db03</li>
<li>192.168.16.44: db04</li>
<li>192.168.16.45: db05</li>
<li>192.168.16.46: db06</li>
<li>192.168.16.47: db07</li>
<li>192.168.16.48: db08</li>
<li>192.168.16.49: db09</li>
<li>192.168.16.50: k8m / K8S Server /</li>
<li>192.168.16.51: k8n1</li>
<li>192.168.16.52: k8n2</li>
<li>192.168.16.53: db13</li>
<li>192.168.16.54: db14</li>
<li>192.168.16.55: db15</li>
<li>192.168.16.56: db16</li>
<li>192.168.16.57: db17</li>
<li>192.168.16.58: db18</li>
<li>192.168.16.59: db19</li>
</ul>
</div>
</div>

<div id="outline-container-orgfce8b53" class="outline-2">
<h2 id="orgfce8b53"><span class="section-number-2">10.</span> Nginx v.s. Moodle</h2>
<div class="outline-text-2" id="text-10">
</div>
<div id="outline-container-org1669dff" class="outline-3">
<h3 id="org1669dff"><span class="section-number-3">10.1.</span> 移除套件</h3>
<div class="outline-text-3" id="text-10-1">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #ECBE7B;">sudo</span> systemctl stop nginx
<span style="color: #ECBE7B;">sudo</span> apt remove nginx php-fpm php-common php-mysql php-gmp php-curl php-intl php-mbstring php-soap php-gd php-xml php-cli  -y
<span style="color: #ECBE7B;">sudo</span> apt purge nginx php-fpm php-common php-mysql php-gmp php-curl php-intl php-mbstring php-soap php-gd php-xml php-cli  -y
<span style="color: #ECBE7B;">sudo</span> apt autoremove
<span style="color: #ECBE7B;">sudo</span> apt autoclean
</pre>
</div>
</div>
</div>
<div id="outline-container-org0857cba" class="outline-3">
<h3 id="org0857cba"><span class="section-number-3">10.2.</span> 安裝套件</h3>
<div class="outline-text-3" id="text-10-2">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #ECBE7B;">sudo</span> apt install nginx php-fpm php-common php-mysql php-gmp php-curl php-intl php-mbstring php-soap php-gd php-xml php-cli php-zip unzip <span style="color: #ECBE7B;">git</span> <span style="color: #ECBE7B;">curl</span> -y
</pre>
</div>
</div>
</div>
<div id="outline-container-orgc9030ee" class="outline-3">
<h3 id="orgc9030ee"><span class="section-number-3">10.3.</span> 編輯php.ini</h3>
<div class="outline-text-3" id="text-10-3">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #ECBE7B;">sudo</span> emacs /etc/php/8.0/fpm/php.ini
</pre>
</div>
<p>
更改內容
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #dcaeea;">memory_limit</span> = 256M
cgi.fix_pathinfo = <span style="color: #da8548; font-weight: bold;">0</span>
<span style="color: #dcaeea;">upload_max_filesize</span> = 100M
<span style="color: #dcaeea;">max_execution_time</span> = <span style="color: #da8548; font-weight: bold;">360</span>
date.timezone = <span style="color: #98be65;">"Asia/Taipei"</span>
</pre>
</div>
<p>
重新啟動php
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #ECBE7B;">sudo</span> systemctl restart php8.0-fpm
</pre>
</div>
</div>
</div>
<div id="outline-container-org3866fb9" class="outline-3">
<h3 id="org3866fb9"><span class="section-number-3">10.4.</span> 安裝Moodle</h3>
<div class="outline-text-3" id="text-10-4">
</div>
<div id="outline-container-orgf8e5757" class="outline-4">
<h4 id="orgf8e5757"><span class="section-number-4">10.4.1.</span> Download</h4>
<div class="outline-text-4" id="text-10-4-1">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #ECBE7B;">cd</span> /opt
<span style="color: #ECBE7B;">sudo</span> <span style="color: #ECBE7B;">git</span> clone git://git.moodle.org/moodle.git
<span style="color: #ECBE7B;">cd</span> moodle
<span style="color: #ECBE7B;">sudo</span> <span style="color: #ECBE7B;">git</span> branch -a
<span style="color: #ECBE7B;">sudo</span> <span style="color: #ECBE7B;">git</span> branch --track MOODLE_39_STABLE origin/MOODLE_39_STABLE
<span style="color: #ECBE7B;">sudo</span> <span style="color: #ECBE7B;">git</span> checkout MOODLE_39_STABLE
</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #ECBE7B;">cd</span> /var/www/html
<span style="color: #ECBE7B;">git</span> clone -b
</pre>
</div>
</div>
</div>
<div id="outline-container-org58d71fb" class="outline-4">
<h4 id="org58d71fb"><span class="section-number-4">10.4.2.</span> 建立目錄</h4>
<div class="outline-text-4" id="text-10-4-2">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #ECBE7B;">sudo</span> <span style="color: #ECBE7B;">cp</span> -R /opt/moodle /var/www/html/
<span style="color: #ECBE7B;">sudo</span> <span style="color: #ECBE7B;">chown</span> -R www-data:www-data /var/www/html/moodle

<span style="color: #ECBE7B;">sudo</span> <span style="color: #ECBE7B;">mkdir</span> -p /var/www/html/moodledata
<span style="color: #ECBE7B;">sudo</span> <span style="color: #ECBE7B;">chmod</span> -R <span style="color: #da8548; font-weight: bold;">755</span> /var/www/html/*
<span style="color: #ECBE7B;">sudo</span> <span style="color: #ECBE7B;">chown</span> www-data:www-data /var/www/html/moodledata

</pre>
</div>
<p>
GRANT ALL PRIVILEGES ON <b>.</b> TO &rsquo;moodle&rsquo;@&rsquo;%&rsquo; WITH GRANT OPTION;
FLUSH PRIVILEGES;
<a href="https://dotblogs.com.tw/supershowwei/2016/10/23/231423">https://dotblogs.com.tw/supershowwei/2016/10/23/231423</a>
</p>
</div>
</div>
<div id="outline-container-org6ef5bd6" class="outline-4">
<h4 id="org6ef5bd6"><span class="section-number-4">10.4.3.</span> 設定Nginx for Moodle</h4>
<div class="outline-text-4" id="text-10-4-3">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #ECBE7B;">sudo</span> emacs /etc/nginx/conf.d/moodle.conf
</pre>
</div>
<p>
內容
</p>
<div class="org-src-container">
<pre class="src src-shell">server <span style="color: #51afef;">{</span>
    listen <span style="color: #da8548; font-weight: bold;">80</span>;
    root /var/www/html/moodle;
    index  index.php index.html index.htm;
    server_name web;

    client_max_body_size 100M;
    autoindex off;
    location / <span style="color: #c678dd;">{</span>
        try_files $<span style="color: #dcaeea;">uri</span> $<span style="color: #dcaeea;">uri</span>/ =<span style="color: #da8548; font-weight: bold;">404</span>;
    <span style="color: #c678dd;">}</span>

    location /dataroot/ <span style="color: #c678dd;">{</span>
      internal;
      <span style="color: #c678dd;">alias</span> /var/www/html/moodledata/;
    <span style="color: #c678dd;">}</span>

    location ~ <span style="color: #c678dd;">[</span>^/<span style="color: #c678dd;">]</span>.php<span style="color: #c678dd;">(</span>/|$<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php7.4-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $<span style="color: #dcaeea;">document_root</span>$<span style="color: #dcaeea;">fastcgi_script_name</span>;
        include fastcgi_params;
    <span style="color: #c678dd;">}</span>
<span style="color: #51afef;">}</span>
Save and close the file then verify the Nginx for any syntax error with the following command:
<span style="color: #5B6268;">#</span><span style="color: #5B6268;">+begin_src shell -r :results output :exports both</span>
<span style="color: #ECBE7B;">sudo</span> nginx -t
</pre>
</div>
<p>
#+end_src
restart
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #ECBE7B;">sudo</span> systemctl restart nginx
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-org0773e0b" class="outline-2">
<h2 id="org0773e0b"><span class="section-number-2">11.</span> Docker commands</h2>
<div class="outline-text-2" id="text-11">
</div>
<div id="outline-container-org2fe45ef" class="outline-3">
<h3 id="org2fe45ef"><span class="section-number-3">11.1.</span> List comtainer</h3>
<div class="outline-text-3" id="text-11-1">
<p>
list running containers
</p>
<div class="org-src-container">
<pre class="src src-shell">docker container <span style="color: #ECBE7B;">ls</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgc6f9efa" class="outline-3">
<h3 id="orgc6f9efa"><span class="section-number-3">11.2.</span> commit</h3>
<div class="outline-text-3" id="text-11-2">
<p>
create a new image <span class="underline">nwImageName</span> from that container
</p>
<div class="org-src-container">
<pre class="src src-shell">docker commit CONTAINER_ID newImageName
</pre>
</div>
</div>
</div>
<div id="outline-container-org747648b" class="outline-3">
<h3 id="org747648b"><span class="section-number-3">11.3.</span> run</h3>
<div class="outline-text-3" id="text-11-3">
<p>
star a container from image
</p>
<div class="org-src-container">
<pre class="src src-shell">docker run newImageName
</pre>
</div>
</div>
</div>
<div id="outline-container-org0a56c0a" class="outline-3">
<h3 id="org0a56c0a"><span class="section-number-3">11.4.</span> duplicate</h3>
<div class="outline-text-3" id="text-11-4">
<p>
duplicate running container nginix:latest to container <span class="underline">newContainer</span> containing image <span class="underline">newImage</span>
</p>
<div class="org-src-container">
<pre class="src src-shell">docker run --name newContainer --volumes-from newImage -d -p 3000:80 nginix:latest
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgabf1f2f" class="outline-2">
<h2 id="orgabf1f2f"><span class="section-number-2">12.</span> References</h2>
<div class="outline-text-2" id="text-12">
<ul class="org-ul">
<li><a href="https://stackoverflow.com/questions/49193307/how-to-duplicate-running-docker-container">How to duplicate running docker container</a></li>
<li><a href="https://www.youtube.com/watch?v=mPquwpxyUQU">Docker 10分钟快速入门</a></li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Yung Chin, Yen</p>
<p class="date">Created: 2023-02-27 Mon 18:02</p>
</div>
</body>
</html>
