<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-06-01 Wed 13:49 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Docker</title>
<meta name="author" content="Yung-Chin Yen" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" type="text/css" href="https://letranger.github.io/org-html-themes/styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://letranger.github.io/org-html-themes/styles/readtheorg/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/js/readtheorg.js"></script>
<style>pre.src{background:#a569bd;color:white;}</style>
</head>
<body>
<div id="content" class="content">
<h1 class="title">Docker</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orga5561c6">1. Install Ubuntu on Mac</a></li>
<li><a href="#orgf9288d9">2. 安裝MariaDB Galera Cluster</a>
<ul>
<li><a href="#org033b8d7">2.1. 安裝系統</a>
<ul>
<li><a href="#orgb865ac8">2.1.1. Installing MariaDB on ALL Nodes</a></li>
</ul>
</li>
<li><a href="#orgb78701a">2.2. 設定50-server.cnf</a></li>
<li><a href="#org7405091">2.3. 設定galera.cnf</a></li>
<li><a href="#org941ade6">2.4. 驗證Verify Replication</a></li>
</ul>
</li>
<li><a href="#orge89a313">3. MariaDB Galera問題處理</a>
<ul>
<li><a href="#org1e70ead">3.1. 重新啟動後,其他node無法join</a></li>
<li><a href="#org2e75610">3.2. master無法galera_new_cluster</a></li>
</ul>
</li>
<li><a href="#org5b14993">4. 移除MariaDB</a></li>
<li><a href="#org4cdb21b">5. 架設haproxy</a>
<ul>
<li><a href="#orgef3ccb9">5.1. 移除</a></li>
<li><a href="#orgb6cdb8d">5.2. 安裝</a></li>
<li><a href="#org7007816">5.3. 編輯haproxy.cfg</a></li>
<li><a href="#org1709b0d">5.4. 重啟haproxy</a></li>
<li><a href="#org04216a9">5.5. 建立mysql-check user</a></li>
<li><a href="#orgdf9ee25">5.6. 測試</a></li>
<li><a href="#orgf31cc2c">5.7. 架設Load Balance（HA Proxy）</a></li>
</ul>
</li>
<li><a href="#orgeb84eb6">6. 監測haproxy</a>
<ul>
<li><a href="#org4d3cbaa">6.1. references</a></li>
<li><a href="#org15869b2">6.2. 大量加入mysql資料</a></li>
<li><a href="#org5e1e1c8">6.3. 被監控端</a></li>
<li><a href="#orgc6a06b5">6.4. 把node_exporter改為service自動執行</a></li>
<li><a href="#orge69a9be">6.5. 把mysqld_exporter改為service自動執行</a></li>
</ul>
</li>
<li><a href="#org3d30ce8">7. Prometheus</a>
<ul>
<li><a href="#org94b1b7d">7.1. 把node_exporter改為service自動執行</a></li>
</ul>
</li>
<li><a href="#orgf14bc03">8. phpmyadmin</a></li>
<li><a href="#org11e6b4d">9. Nginx v.s. Moodle</a>
<ul>
<li><a href="#org6512a63">9.1. 移除套件</a></li>
<li><a href="#org3625d91">9.2. 安裝套件</a></li>
<li><a href="#org17ab607">9.3. 編輯php.ini</a></li>
<li><a href="#orgbacea28">9.4. 安裝Moodle</a>
<ul>
<li><a href="#org6ddd10b">9.4.1. Download</a></li>
<li><a href="#org264dbe3">9.4.2. 建立目錄</a></li>
<li><a href="#org85601fb">9.4.3. 設定Nginx for Moodle</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org4c531bb">10. Docker commands</a>
<ul>
<li><a href="#orgfffcd2f">10.1. List comtainer</a></li>
<li><a href="#org31a10a3">10.2. commit</a></li>
<li><a href="#orgee1a91c">10.3. run</a></li>
<li><a href="#orga81bd42">10.4. duplicate</a></li>
</ul>
</li>
<li><a href="#orge3b69e9">11. References</a></li>
</ul>
</div>
</div>

<div id="outline-container-orga5561c6" class="outline-2">
<h2 id="orga5561c6"><span class="section-number-2">1.</span> Install Ubuntu on Mac</h2>
<div class="outline-text-2" id="text-1">
<ol class="org-ol">
<li>Download Ubuntu ISO<br /></li>
<li>Open Disk Utility, Create 1 Partition to Mac OS Extended (Journaled) for USB Stick.<br /></li>
<li>Click the <b>Options</b> Button and ensure that GUID Partition Table is selected and then click OK.<br /></li>
<li>Open Terminal and enter the following commands<br />
<ol class="org-ol">
<li><p>
Convert ISO to IMG<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">hdiutil convert -format UDRW -o ~/path/to/target.img ~/path/to/ubuntu.iso
</pre>
</div></li>
<li><p>
Find USB disk Number and unmount it<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">diskutil list
diskutil unmountDisk /dev/diskN
</pre>
</div></li>
<li><p>
Create bootable USB<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">sudo dd <span style="color: #dcaeea;">if</span>=/path/to/downloaded.img <span style="color: #dcaeea;">of</span>=/dev/diskN <span style="color: #dcaeea;">bs</span>=1m
</pre>
</div></li>
<li>Install<br /></li>
</ol></li>
</ol>
</div>
</div>
<div id="outline-container-orgf9288d9" class="outline-2">
<h2 id="orgf9288d9"><span class="section-number-2">2.</span> 安裝MariaDB Galera Cluster</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li><a href="https://cloudinfrastructureservices.co.uk/how-to-setup-mariadb-clustering-on-ubuntu-20-04/">How to Setup Mariadb Clustering on Ubuntu 20.04</a><br /></li>
</ul>
</div>
<div id="outline-container-org033b8d7" class="outline-3">
<h3 id="org033b8d7"><span class="section-number-3">2.1.</span> 安裝系統</h3>
<div class="outline-text-3" id="text-2-1">
</div>
<div id="outline-container-orgb865ac8" class="outline-4">
<h4 id="orgb865ac8"><span class="section-number-4">2.1.1.</span> Installing MariaDB on ALL Nodes</h4>
<div class="outline-text-4" id="text-2-1-1">
<div class="org-src-container">
<pre class="src src-shell">sudo apt install mariadb-server -y
sudo systemctl start mariadb
sudo mysql_secure_installation
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgb78701a" class="outline-3">
<h3 id="orgb78701a"><span class="section-number-3">2.2.</span> 設定50-server.cnf</h3>
<div class="outline-text-3" id="text-2-2">
<div class="org-src-container">
<pre class="src src-shell">sudo emacs /etc/mysql/mariadb.conf.d/50-server.cnf
</pre>
</div>
<p>
Comment the bind line on the file /etc/mysql/mariadb.conf.d/50-server.cnf which binds MariaDB service to 127.0.0.1<br />
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Instead of skip-networking the default is now to listen only on</span>
<span style="color: #5B6268;">## </span><span style="color: #5B6268;">localhost which is more compatible and is not less secure.</span>
<span style="color: #5B6268;">#</span><span style="color: #5B6268;">bind-address            = 127.0.0.1</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org7405091" class="outline-3">
<h3 id="org7405091"><span class="section-number-3">2.3.</span> 設定galera.cnf</h3>
<div class="outline-text-3" id="text-2-3">
<ol class="org-ol">
<li><p>
Configuring the <b>First</b> Node<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">sudo emacs /etc/mysql/conf.d/galera.cnf
</pre>
</div>
<div class="org-src-container">
<pre class="src src-shell">[mysqld]
<span style="color: #dcaeea;">binlog_format</span>=ROW
default-storage-engine=innodb
<span style="color: #dcaeea;">innodb_autoinc_lock_mode</span>=<span style="color: #da8548; font-weight: bold;">2</span>
<span style="color: #dcaeea;">innodb_locks_unsafe_for_binlog</span>=<span style="color: #da8548; font-weight: bold;">1</span>
<span style="color: #dcaeea;">innodb_doublewrite</span>=<span style="color: #da8548; font-weight: bold;">1</span>
<span style="color: #5B6268;">#</span><span style="color: #5B6268;">bind-address=0.0.0.0</span>

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">Galera Provider Configuration</span>
<span style="color: #dcaeea;">wsrep_on</span>=ON
<span style="color: #dcaeea;">wsrep_provider</span>=/usr/lib/galera/libgalera_smm.so

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">Galera Cluster Configuration</span>
<span style="color: #dcaeea;">wsrep_provider_options</span>=<span style="color: #98be65;">"gcache.size=256M; gcache.page_size=128M"</span>
<span style="color: #dcaeea;">wsrep_cluster_name</span>=<span style="color: #98be65;">"TNFSH_DB_Cluster"</span>
<span style="color: #dcaeea;">wsrep_cluster_address</span>=<span style="color: #98be65;">"gcomm://192.168.16.41, 192.168.16.42, 192.168.16.43, 192.168.16.44, 192.168.16.45, 192.168.16.46, 192.168.16.47, 192.168.16.48, 192.168.16.49"</span>

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">Galera Synchronization Configuration</span>
<span style="color: #dcaeea;">wsrep_sst_method</span>=rsync

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">Galera Node Configuration</span>
<span style="color: #dcaeea;">wsrep_node_address</span>=<span style="color: #98be65;">"192.168.16.41"</span>
<span style="color: #dcaeea;">wsrep_node_name</span>=<span style="color: #98be65;">"TNFSH_DB01"</span>

</pre>
</div></li>
<li><p>
Configuring the <b>Second</b> Node<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">sudo emacs /etc/mysql/conf.d/galera.cnf
</pre>
</div>
<div class="org-src-container">
<pre class="src src-shell">[mysqld]
<span style="color: #dcaeea;">binlog_format</span>=ROW
default-storage-engine=innodb
<span style="color: #dcaeea;">innodb_autoinc_lock_mode</span>=<span style="color: #da8548; font-weight: bold;">2</span>
<span style="color: #dcaeea;">innodb_locks_unsafe_for_binlog</span>=<span style="color: #da8548; font-weight: bold;">1</span>
<span style="color: #dcaeea;">innodb_doublewrite</span>=<span style="color: #da8548; font-weight: bold;">1</span>
<span style="color: #5B6268;">#</span><span style="color: #5B6268;">bind-address=0.0.0.0</span>

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">Galera Provider Configuration</span>
<span style="color: #dcaeea;">wsrep_on</span>=ON
<span style="color: #dcaeea;">wsrep_provider</span>=/usr/lib/galera/libgalera_smm.so

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">Galera Cluster Configuration</span>
<span style="color: #dcaeea;">wsrep_provider_options</span>=<span style="color: #98be65;">"gcache.size=256M; gcache.page_size=128M"</span>
<span style="color: #dcaeea;">wsrep_cluster_name</span>=<span style="color: #98be65;">"TNFSH_DB_Cluster"</span>
<span style="color: #dcaeea;">wsrep_cluster_address</span>=<span style="color: #98be65;">"gcomm://192.168.16.41, 192.168.16.42, 192.168.16.43, 192.168.16.44, 192.168.16.45, 192.168.16.46, 192.168.16.47, 192.168.16.48, 192.168.16.49"</span>

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">Galera Synchronization Configuration</span>
<span style="color: #dcaeea;">wsrep_sst_method</span>=rsync

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">Galera Node Configuration</span>
<span style="color: #dcaeea;">wsrep_node_address</span>=<span style="color: #98be65;">"192.168.16.42"</span>
<span style="color: #dcaeea;">wsrep_node_name</span>=<span style="color: #98be65;">"TNFSH_DB02"</span>
</pre>
</div></li>
<li>Starting the Galera Cluster<br />
<ol class="org-ol">
<li><p>
Stop MariaDB on ALL Nodes and make sure MariaDB service is stopped<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">sudo systemctl stop mariadb
sudo systemctl status mariadb
</pre>
</div></li>
<li><p>
Start the <b>First</b> Node<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">sudo galera_new_cluster
</pre>
</div></li>
<li><p>
Make sure the cluster status<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">mysql -u root -p -e <span style="color: #98be65;">"SHOW STATUS LIKE 'wsrep_cluster_size'"</span>
</pre>
</div></li>
<li><p>
Start the <b>Second</b> Node<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">sudo systemctl start mariadb
</pre>
</div></li>
<li><p>
Make sure the cluster status<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">mysql -u root -p -e <span style="color: #98be65;">"SHOW STATUS LIKE 'wsrep_cluster_size'"</span>
</pre>
</div></li>
<li><p>
Start the <b>Third</b> Node<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">sudo systemctl start mariadb
</pre>
</div></li>
<li><p>
Make sure the cluster status<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">mysql -u root -pilov1tnfsh -e <span style="color: #98be65;">"SHOW STATUS LIKE 'wsrep_cluster_size'"</span>
</pre>
</div></li>
</ol></li>
</ol>
</div>
</div>
<div id="outline-container-org941ade6" class="outline-3">
<h3 id="org941ade6"><span class="section-number-3">2.4.</span> 驗證Verify Replication</h3>
<div class="outline-text-3" id="text-2-4">
<ol class="org-ol">
<li><p>
Create a Database and Table on the First Node<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">mysql -u root -p
CREATE DATABASE classdb;
</pre>
</div></li>
<li><p>
Create a table named students<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">USE classdb;
CREATE TABLE students (id int, name varchar(<span style="color: #da8548; font-weight: bold;">20</span>), surname varchar(<span style="color: #da8548; font-weight: bold;">20</span>));
</pre>
</div></li>
<li><p>
Insert some data into studetns table:<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">INSERT INTO students VALUES (1,<span style="color: #98be65;">"&#37101;&#23567;&#22914;"</span>,<span style="color: #98be65;">"Ruby"</span>);
INSERT INTO students VALUES (2,<span style="color: #98be65;">"&#38991;&#23567;&#21746;"</span>,<span style="color: #98be65;">"James"</span>);
INSERT INTO students VALUES (3,<span style="color: #98be65;">"&#38991;&#23567;&#24070;"</span>,<span style="color: #98be65;">"Vanessa"</span>);
</pre>
</div></li>
<li><p>
Verify the inserted data with the following command:<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">SELECT * FROM students;
</pre>
</div></li>
</ol>
<ol class="org-ol">
<li><p>
Verify Replication on the Second and Third Node<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">mysql -u root -p
SHOW DATABASES;
USE classdb;
SELECT * FROM students;
</pre>
</div>
<p>
Insert some data on <b>Second</b> Node<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">INSERT INTO students VALUES (4,<span style="color: #98be65;">"&#38991;&#23567;&#36914;"</span>,<span style="color: #98be65;">"Letranger"</span>);
</pre>
</div>
<p>
Verify on other nodes<br />
</p></li>
</ol>
</div>
</div>
</div>
<div id="outline-container-orge89a313" class="outline-2">
<h2 id="orge89a313"><span class="section-number-2">3.</span> MariaDB Galera問題處理</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li><a href="https://www.cnblogs.com/nulige/articles/8470001.html">問題處理 </a>太好了<br /></li>
<li><a href="https://mariadb.com/kb/en/getting-started-with-mariadb-galera-cluster/">Getting Started with MariaDB Galera Cluster</a><br /></li>
</ul>
</div>
<div id="outline-container-org1e70ead" class="outline-3">
<h3 id="org1e70ead"><span class="section-number-3">3.1.</span> 重新啟動後,其他node無法join</h3>
<div class="outline-text-3" id="text-3-1">
<ul class="org-ul">
<li>正常第一次启动集群，使用命令：galera_new_cluster<br /></li>
<li><p>
整個集群關閉後，再重新啟動，則打開任一主機，輸入命令：<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">sudo emacs /var/lib/mysql/grastate.dat
</pre>
</div>
<p>
將seqno改為1<br />
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #5B6268;">#</span><span style="color: #5B6268;">GALERA savedd state</span>
version:2.1
uuid: &#33258;&#24049;&#30340;cluster id
seqno: -1
safe_to_bootstrap:0
</pre>
</div>
<p>
啟動 galera_new_cluster，這是master<br />
其他node則用systemctl start mariadb啟動<br />
</p></li>
</ul>
</div>
</div>
<div id="outline-container-org2e75610" class="outline-3">
<h3 id="org2e75610"><span class="section-number-3">3.2.</span> master無法galera_new_cluster</h3>
<div class="outline-text-3" id="text-3-2">
<p>
狀況:<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">[db1]# galera_new_cluster
Job for mariadb.service failed because the control process exited with error code.
See <span style="color: #98be65;">"systemctl status mariadb.service"</span> and <span style="color: #98be65;">"journalctl -xe"</span> for details.
</pre>
</div>
<div class="org-src-container">
<pre class="src src-shell">sudo emacs /var/lib/mysql/grastate.dat
</pre>
</div>
<p>
將safe_to_bootstrap改為1<br />
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #5B6268;">#</span><span style="color: #5B6268;">GALERA savedd state</span>
version:2.1
uuid: &#33258;&#24049;&#30340;cluster id
seqno: -1
safe_to_bootstrap:0
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org5b14993" class="outline-2">
<h2 id="org5b14993"><span class="section-number-2">4.</span> 移除MariaDB</h2>
<div class="outline-text-2" id="text-4">
<div class="org-src-container">
<pre class="src src-shell">sudo systemctl stop mariadb
sudo apt remove <span style="color: #98be65;">'mariadb*'</span> -y
sudo apt purge <span style="color: #98be65;">'mariadb*'</span> -y
sudo apt remove <span style="color: #98be65;">'mysql*'</span> -y
sudo apt purge <span style="color: #98be65;">'mysql*'</span> -y
sudo apt autoremove -y
sudo apt autoclean -y
sudo apt update -y
sudo apt upgrade -y
sudo apt autoremove
sudo apt-get --fix-broken install
sudo rm -rf /etc/mysql /var/lib/mysql
sudo reboot
</pre>
</div>
</div>
</div>
<div id="outline-container-org4cdb21b" class="outline-2">
<h2 id="org4cdb21b"><span class="section-number-2">5.</span> 架設haproxy</h2>
<div class="outline-text-2" id="text-5">
<ul class="org-ul">
<li><a href="https://gary840227.medium.com/mariadb-cluster-f7220e9eaac8">如何建置 MariaDb Galera Cluster</a><br /></li>
</ul>
</div>
<div id="outline-container-orgef3ccb9" class="outline-3">
<h3 id="orgef3ccb9"><span class="section-number-3">5.1.</span> 移除</h3>
<div class="outline-text-3" id="text-5-1">
<div class="org-src-container">
<pre class="src src-shell">sudo apt remove haproxy -y
sudo apt purge haproxy -y
sudo apt autoclean -y
sudo apt autoremove -y
sudo rm -rf /etc/haproxy
</pre>
</div>
</div>
</div>
<div id="outline-container-orgb6cdb8d" class="outline-3">
<h3 id="orgb6cdb8d"><span class="section-number-3">5.2.</span> 安裝</h3>
<div class="outline-text-3" id="text-5-2">
<div class="org-src-container">
<pre class="src src-shell">sudo apt install haproxy -y
</pre>
</div>
</div>
</div>
<div id="outline-container-org7007816" class="outline-3">
<h3 id="org7007816"><span class="section-number-3">5.3.</span> 編輯haproxy.cfg</h3>
<div class="outline-text-3" id="text-5-3">
<div class="org-src-container">
<pre class="src src-shell">sudo emacs /etc/haproxy/haproxy.cfg
</pre>
</div>
<p>
內容如下:<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">global
         <span style="color: #5B6268;"># </span><span style="color: #5B6268;">log required rsyslog         log /dev/log    local0</span>
        <span style="color: #c678dd;">log</span> /dev/log    local1 notice
        chroot /var/lib/haproxy
        stats socket /run/haproxy/admin.sock mode <span style="color: #da8548; font-weight: bold;">660</span> level admin expose-fd listeners
        stats timeout 30s        <span style="color: #5B6268;"># </span><span style="color: #5B6268;">user and group will be run as</span>
        user haproxy
        group haproxy
        daemon

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">Default SSL material locations</span>
        ca-base /etc/ssl/certs
        crt-base /etc/ssl/private

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">Default ciphers to use on SSL-enabled listening sockets.</span>
<span style="color: #5B6268;"># </span><span style="color: #5B6268;">For more information, see ciphers(1SSL). This list is from:</span>
<span style="color: #5B6268;">#  </span><span style="color: #5B6268;">https://hynek.me/articles/hardening-your-web-servers-ssl-ciphers/</span>
<span style="color: #5B6268;"># </span><span style="color: #5B6268;">An alternative list with additional directives can be obtained from https://mozilla.github.io/server-side-tls/ssl-config-generator/?server=haproxyssl-default-bind-ciphersECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:RSA+AESGCM:RSA+AES:!aNULL:!MD5:!DSSssl-default-bind-options no-sslv3</span>
defaults
        <span style="color: #c678dd;">log</span>     global
        mode    http
        option  httplog
        option  dontlognull
        timeout connect <span style="color: #da8548; font-weight: bold;">5000</span>
        timeout client  <span style="color: #da8548; font-weight: bold;">50000</span>
        timeout server  <span style="color: #da8548; font-weight: bold;">50000</span>
        errorfile <span style="color: #da8548; font-weight: bold;">400</span> /etc/haproxy/errors/400.http
        errorfile <span style="color: #da8548; font-weight: bold;">403</span> /etc/haproxy/errors/403.http
        errorfile <span style="color: #da8548; font-weight: bold;">408</span> /etc/haproxy/errors/408.http
        errorfile <span style="color: #da8548; font-weight: bold;">500</span> /etc/haproxy/errors/500.http
        errorfile <span style="color: #da8548; font-weight: bold;">502</span> /etc/haproxy/errors/502.http
        errorfile <span style="color: #da8548; font-weight: bold;">503</span> /etc/haproxy/errors/503.http
        errorfile <span style="color: #da8548; font-weight: bold;">504</span> /etc/haproxy/errors/504.http

listen galera
    bind 192.168.16.40:3306
    balance roundrobin <span style="color: #5B6268;">#  </span><span style="color: #5B6268;">load balancer policy</span>
    mode tcp <span style="color: #5B6268;"># </span><span style="color: #5B6268;">(tcp &#35373;&#32622;&#28858; layer 7 , http &#28858; layer 4)</span>
    option tcpka <span style="color: #5B6268;"># </span><span style="color: #5B6268;">enable keepalive to maintain tcp connection</span>
    option mysql-check user haproxy <span style="color: #5B6268;"># </span><span style="color: #5B6268;">enable database server check</span>
    server TNFSH_DB01 192.168.16.41:3306 check weight <span style="color: #da8548; font-weight: bold;">1</span>
    server TNFSH_DB02 192.168.16.42:3306 check weight <span style="color: #da8548; font-weight: bold;">1</span>
    server TNFSH_DB03 192.168.16.43:3306 check weight <span style="color: #da8548; font-weight: bold;">1</span>
    server TNFSH_DB04 192.168.16.44:3306 check weight <span style="color: #da8548; font-weight: bold;">1</span>
    server TNFSH_DB05 192.168.16.45:3306 check weight <span style="color: #da8548; font-weight: bold;">1</span>

listen stats
   bind 0.0.0.0:9000
   mode http
   stats enable <span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#21855;&#29992;&#29376;&#24907;</span>
   stats uri /stats   <span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#32178;&#22336;&#36335;&#24465;</span>
   stats realm HAProxy<span style="color: #98be65;">\ </span>Statistics
   stats auth howtoforge:howtoforge <span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#35373;&#23450;&#24115;&#34399;&#23494;&#30908;</span>
   stats admin if TRUE <span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#35373;&#23450;&#20351;&#29992;&#32773;&#30331;&#20837;&#24460;&#28858;&#31649;&#29702;&#32773;</span>
   stats refresh 30s <span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#27599; 30 &#31186;&#21047;&#26032;&#30435;&#25511;&#30059;&#38754;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org1709b0d" class="outline-3">
<h3 id="org1709b0d"><span class="section-number-3">5.4.</span> 重啟haproxy</h3>
<div class="outline-text-3" id="text-5-4">
<div class="org-src-container">
<pre class="src src-shell">sudo systemctl restart haproxy
</pre>
</div>
<p>
觀察 <a href="http://192.168.16.40:9000/stats">http://192.168.16.40:9000/stats</a><br />
帳密: howtoforge / howtoforge<br />
</p>
</div>
</div>
<div id="outline-container-org04216a9" class="outline-3">
<h3 id="org04216a9"><span class="section-number-3">5.5.</span> 建立mysql-check user</h3>
<div class="outline-text-3" id="text-5-5">
<p>
於任一node<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">sudo mysql -u root -pilov1tnfsh
create user <span style="color: #98be65;">'haproxy'</span>@<span style="color: #98be65;">'192.168.16.40'</span>; <span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#24115;&#34399;@ip</span>
flush privileges;
</pre>
</div>
</div>
</div>
<div id="outline-container-orgdf9ee25" class="outline-3">
<h3 id="orgdf9ee25"><span class="section-number-3">5.6.</span> 測試</h3>
<div class="outline-text-3" id="text-5-6">
<p>
測試 haproxy 是否將我們導向不同的 mariadb , 我們對每個節點的 mariadb 設定專屬的 server-id<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">sudo mysql -h192.168.16.40 -uroot -pilov1tnfsh -e <span style="color: #98be65;">"SET GLOBAL server_id=161"</span>
sudo mysql -h192.168.16.40 -uroot -pilov1tnfsh -e <span style="color: #98be65;">"SET GLOBAL server_id=162"</span>
sudo mysql -h192.168.16.40 -uroot -pilov1tnfsh -e <span style="color: #98be65;">"SET GLOBAL server_id=163"</span>
sudo mysql -h192.168.16.40 -uroot -pilov1tnfsh -e <span style="color: #98be65;">"SET GLOBAL server_id=164"</span>
sudo mysql -h192.168.16.40 -uroot -pilov1tnfsh -e <span style="color: #98be65;">"SET GLOBAL server_id=165"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgf31cc2c" class="outline-3">
<h3 id="orgf31cc2c"><span class="section-number-3">5.7.</span> 架設Load Balance（HA Proxy）</h3>
<div class="outline-text-3" id="text-5-7">
<ol class="org-ol">
<li><p>
關閉防火牆<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">   sudo ufw disable
   sudo ufw status
</pre>
</div></li>
<li><p>
安裝HA Proxy<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">   sudo apt install haproxy
</pre>
</div></li>
<li>建立與設定clustercheck<br />
<ol class="org-ol">
<li><p>
於MariaDB 所有Nodes下載並設定clustercheck，將檔案放在/usr/bin下，設定可執行權限<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">      git clone https://github.com/olafz/percona-clustercheck
      <span style="color: #c678dd;">cd</span> percona-clustercheck
      <span style="color: #c678dd;">cd</span> clustercheck
      chmod <span style="color: #da8548; font-weight: bold;">755</span> clustercheck
      sudo mv clustercheck /usr/bin
      ls -al /usr/bin/clustercheck
</pre>
</div></li>
<li><p>
為clustercheck建一組檢查用的mysql帳號<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">mysql -u root -p
GRANT PROCESS ON *.* TO <span style="color: #98be65;">'clustercheckuser'</span>@<span style="color: #98be65;">'localhost'</span> IDENTIFIED BY <span style="color: #98be65;">'clustercheckpassword!'</span> ;
FLUSH PRIVILEGES;
</pre>
</div></li>
</ol></li>
<li>於MariaDB所有Nodes安裝與設定xinetd<br />
讓clustercheck可以透過網路執行<br />
<ol class="org-ol">
<li><p>
安裝xinetd<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">      sudo apt install xinetd
</pre>
</div></li>
<li><p>
設定xinetd<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">sudo emacs /etc/xinetd.d/mysqlchk
</pre>
</div>
<p>
內容:<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">      <span style="color: #5B6268;"># </span><span style="color: #5B6268;">default: on</span>
      <span style="color: #5B6268;"># </span><span style="color: #5B6268;">description: mysqlchk</span>
      service mysqlchk
      {
             <span style="color: #dcaeea;">disable</span> = no
             <span style="color: #dcaeea;">flags</span> = REUSE
             <span style="color: #dcaeea;">socket_type</span> = stream
             <span style="color: #dcaeea;">port</span> = <span style="color: #da8548; font-weight: bold;">9200</span>
             <span style="color: #dcaeea;">wait</span> = no
             <span style="color: #dcaeea;">user</span> = nobody
             <span style="color: #dcaeea;">server</span> = /usr/bin/clustercheck
             <span style="color: #dcaeea;">log_on_failure</span> += USERID
             <span style="color: #dcaeea;">only_from</span> = 0.0.0.0/0
             <span style="color: #dcaeea;">per_source</span> = UNLIMITED
      }
</pre>
</div></li>
<li><p>
調整services<br />
在上方中，我們設定了9200來當我們觸發xinetd的Port，所以要在/etc/services裡做一下調整，編輯 /etc/services來調整，取消原本的9200，加入我們新增的mysqlchk<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">      mysqlchk        9200/tcp                        <span style="color: #5B6268;">#</span><span style="color: #5B6268;">Galera Clustercheck</span>
</pre>
</div></li>
<li><p>
啟動xinetd<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">      sudo /etc/init.d/xinetd start
</pre>
</div></li>
<li><p>
設定xinetd重啟動後自動啟動<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">      sudo pdate-rc.d xinetd defaults
</pre>
</div>
<p>
server TNFSH_DB03 192.168.16.43:3306 check port 9200 weight 1<br />
server TNFSH_DB04 192.168.16.44:3306 check port 9200 weight 1<br />
server TNFSH_DB05 192.168.16.45:3306 check port 9200 weight 1<br />
</p></li>
<li><p>
測試<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">      telnet localhost <span style="color: #da8548; font-weight: bold;">9200</span>
</pre>
</div>
<p>
結果<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">      Trying 127.0.0.1...
      Connected to localhost.
      Escape character is <span style="color: #98be65;">'^]'</span>.
      HTTP/1.1 <span style="color: #da8548; font-weight: bold;">503</span> Service Unavailable
      Content-Type: text/plain
      Connection: close
      Content-Length: <span style="color: #da8548; font-weight: bold;">44</span>

      Percona XtraDB Cluster Node is not synced.
      Connection closed by foreign host.
</pre>
</div></li>
</ol></li>

<li><p>
Install the latest HAProxy using a PPA<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">sudo apt install --no-install-recommends software-properties-common
sudo add-apt-repository ppa:vbernat/haproxy-2.4 -y
sudo apt install <span style="color: #dcaeea;">haproxy</span>=2.4.<span style="color: #98be65;">\*</span>
</pre>
</div></li>
<li><p>
Update and upgrade<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">sudo apt update
sudo apt upgrade -y
</pre>
</div></li>
<li>設定HA Proxy<br />
<ol class="org-ol">
<li>編輯/etc/haproxy/haproxy.cfg<br /></li>
<li>刪除原本內容<br /></li>
<li><p>
加入<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">global
       <span style="color: #c678dd;">log</span> 127.0.0.1   local0
       <span style="color: #c678dd;">log</span> 127.0.0.1   local1 notice
       maxconn <span style="color: #da8548; font-weight: bold;">1024</span>
       user haproxy
       group haproxy
       daemon
defaults
       <span style="color: #c678dd;">log</span>     global
       mode    http
       option  tcplog
       option  dontlognull
       retries <span style="color: #da8548; font-weight: bold;">3</span>
       option  redispatch
       maxconn <span style="color: #da8548; font-weight: bold;">1024</span>
       timeout connect 5000ms
       timeout client 50000ms
       timeout server 50000ms
listen mariadb_cluster_writes 0.0.0.0:13304
<span style="color: #5B6268;">## </span><span style="color: #5B6268;">A failover pool for writes to ensure writes only hit one node at a time.</span>
       mode tcp
       option httpchk
       server galera-node01 192.168.16.41:3306 check port <span style="color: #da8548; font-weight: bold;">9200</span>
       server galera-node02 192.168.16.42:3306 check port <span style="color: #da8548; font-weight: bold;">9200</span> backup
listen mariadb_cluster_reads 0.0.0.0:13305
<span style="color: #5B6268;">## </span><span style="color: #5B6268;">A load-balanced pool for reads to utilize all nodes for reads.</span>
       mode tcp
       balance leastconn
       option httpchk
       server galera-node01 192.168.16.41:3306 check port <span style="color: #da8548; font-weight: bold;">9200</span>
       server galera-node02 192.168.16.42:3306 check port <span style="color: #da8548; font-weight: bold;">9200</span>
listen stats 0.0.0.0:9000
<span style="color: #5B6268;">## </span><span style="color: #5B6268;">HAProxy stats web gui.</span>
       mode http
       stats enable
       stats uri /haproxy_status
       stats realm HAProxy<span style="color: #98be65;">\ </span>Statistics
       stats auth haproxy:haproxy
       stats admin if TRUE
</pre>
</div></li>
</ol></li>
<li><p>
內容說明<br />
</p>
<ol class="org-ol">
<li>Writer connection（寫入連線）：寫入連線要保持在同一台，也就是說不管有幾台機器連透過「寫入連線」的方式連入時，都要導到同一台機器；不過當機器有問題時，也能夠進行failover，下方大概解釋一下設定。<br />
<ul class="org-ul">
<li>listen mariadb_cluster_writes 0.0.0.0:13304<br />
說明：宣告監聽(listen)，名稱為mariadb_cluster_writes，開放任意IP連入13304 Port(0.0.0.0:13304)。<br /></li>
<li>mode tcp<br />
說明：使用tcp或http方式連入，這邊設定是tcp。<br /></li>
<li>option httpchk<br />
說明：HA Proxy在確認後方的資料庫時，透過HTTP方式來判斷後端是否正常。<br /></li>
<li>server galera-node01 192.168.43.101:3306 check port 9200<br />
說明：宣告server，server的暱稱為 galera-node01，實稱上的IP與Port是 192.168.43.101:3306，確認正常與否的Port是9200。<br /></li>
<li>server galera-node02 192.168.43.102:3306 check port 9200 backup<br />
說明：基本上與d是一樣的，不過最後多了一個backup，意思是當正常的機器有問題時，才將連線導至這一台server，如果沒有這個backup的話，HA Proxy會實行分流，可能會導到不同的server，請注意。<br /></li>
</ul></li>
<li>Read connection（讀取連線）：讀取時不導到特定一台機器，只是單純實行Load Balance功能，這邊的設定跟讀取的設定有三點不太一樣，說明如下：<br />
<ul class="org-ul">
<li>listen mariadb_cluster_writes 0.0.0.0:13305<br />
說明：我們在Read connection中設定13305的Port。<br /></li>
<li>balance leastconn<br />
說明：分流的方式之一，將使用者導到最少人連線的server。<br /></li>
<li>server無backup說定<br />
說明：因為server中無backup的設定，所以會實作分流。<br /></li>
</ul></li>
<li>網頁監看：這一個設定只是單純讓使用者在網頁上可以看到MariaDB的狀態。<br />
<ul class="org-ul">
<li>listen stats 0.0.0.0:9000<br />
說明：宣告監聽(listen)，名稱為stats ，開放任意IP連入9000 Port(0.0.0.0:9000)。<br /></li>
<li>mode http<br />
說明：使用tcp或http方式連入，這邊設定是http。<br /></li>
<li>stats enable<br />
說明：設定狀態為啟用。<br /></li>
<li>stats uri /haproxy_status<br />
說明：設定HTTP的URL，所以我們等一下要連入的網址是<a href="http://ip:9000/haproxy_status">http://ip:9000/haproxy_status</a>。<br /></li>
<li>stats realm HAProxy\ Statistics<br />
說明：設定使用者連線時，在輸入帳號密碼的視窗標題，通常會搭配下方的stats auth設定使用。<br /></li>
<li>stats auth haproxy:haproxy<br />
說明：設定使用者連線時的帳號密碼。<br /></li>
<li>stats admin if TRUE<br />
說明：設定使用者連線後的角色為管理員角色；管理員與一般使用者的差別在於－管理員角色有權限在網頁上針對HA Proxy上管理的伺服器做一些動作。<br /></li>
</ul></li>
</ol>
<ol class="org-ol">
<li><p>
啟動與測試HA Proxy<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">service haproxy start
</pre>
</div></li>
</ol></li>
</ol>
</div>
</div>
</div>
<div id="outline-container-orgeb84eb6" class="outline-2">
<h2 id="orgeb84eb6"><span class="section-number-2">6.</span> 監測haproxy</h2>
<div class="outline-text-2" id="text-6">
</div>
<div id="outline-container-org4d3cbaa" class="outline-3">
<h3 id="org4d3cbaa"><span class="section-number-3">6.1.</span> references</h3>
<div class="outline-text-3" id="text-6-1">
<ul class="org-ul">
<li><a href="https://codertw.com/%E4%BC%BA%E6%9C%8D%E5%99%A8/144308/">使用Prometheus Grafana監控MySQL實踐</a><br /></li>
<li><a href="https://www.gushiciku.cn/pl/p9ZR/zh-tw">Prometheus+Grafana 基礎及簡單搭建</a><br /></li>
<li><a href="https://www.lisenet.com/2021/monitor-haproxy-with-grafana-and-prometheus-haproxy_exporter/">Monitor HAProxy with Grafana and Prometheus (haproxy_exporter)</a><br /></li>
<li><a href="https://ithelp.ithome.com.tw/articles/10209805">[Day 30] Prometheus &amp; Intermission </a><br /></li>
</ul>
</div>
</div>
<div id="outline-container-org15869b2" class="outline-3">
<h3 id="org15869b2"><span class="section-number-3">6.2.</span> 大量加入mysql資料</h3>
<div class="outline-text-3" id="text-6-2">
<div class="org-src-container">
<pre class="src src-shell">CREATE TABLE <span style="color: #51afef; font-weight: bold;">`data3`</span>
(
  <span style="color: #51afef; font-weight: bold;">`id`</span>         bigint(<span style="color: #da8548; font-weight: bold;">20</span>) NOT NULL      AUTO_INCREMENT,
  <span style="color: #51afef; font-weight: bold;">`datetime`</span>   timestamp  NULL          DEFAULT CURRENT_TIMESTAMP,
  <span style="color: #51afef; font-weight: bold;">`channel`</span>    int(<span style="color: #da8548; font-weight: bold;">11</span>)                  DEFAULT NULL,
  <span style="color: #51afef; font-weight: bold;">`value`</span>      float                    DEFAULT NULL,

  PRIMARY KEY (<span style="color: #51afef; font-weight: bold;">`id`</span>)
);


DELIMITER $<span style="color: #dcaeea;">$</span>
CREATE PROCEDURE generate_data3()
BEGIN
  DECLARE i INT DEFAULT <span style="color: #da8548; font-weight: bold;">0</span>;
  WHILE i &lt; <span style="color: #da8548; font-weight: bold;">500000</span> DO
    INSERT INTO <span style="color: #51afef; font-weight: bold;">`data3`</span> (<span style="color: #51afef; font-weight: bold;">`datetime`</span>,<span style="color: #51afef; font-weight: bold;">`value`</span>,<span style="color: #51afef; font-weight: bold;">`channel`</span>) VALUES (
      FROM_UNIXTIME(UNIX_TIMESTAMP(<span style="color: #98be65;">'2014-01-01 01:00:00'</span>)+FLOOR(RAND()*31536000)),
      ROUND(RAND()*100,2),
      <span style="color: #da8548; font-weight: bold;">1</span>
    );
    SET <span style="color: #dcaeea;">i</span> = i + <span style="color: #da8548; font-weight: bold;">1</span>;
  END WHILE;
END$<span style="color: #dcaeea;">$</span>
DELIMITER ;

CALL generate_data3();
</pre>
</div>
</div>
</div>
<div id="outline-container-org5e1e1c8" class="outline-3">
<h3 id="org5e1e1c8"><span class="section-number-3">6.3.</span> 被監控端</h3>
<div class="outline-text-3" id="text-6-3">
<ol class="org-ol">
<li>install go<br /></li>
<li>download node_exporter<br /></li>
<li>解壓至/usr/local<br /></li>
<li>執行node_exporter<br /></li>
<li>download mysqld_exporter<br /></li>
<li>解壓至/usr/local<br /></li>
<li>編輯.my.cnf<br /></li>
<li>執行mysqld_exporter<br /></li>
</ol>
<div class="org-src-container">
<pre class="src src-shell">[client]
<span style="color: #dcaeea;">user</span>=root
<span style="color: #dcaeea;">password</span>=ilov1tnfsh
</pre>
</div>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #c678dd;">cd</span> ~
sudo snap install go --classic
wget https://github.com/prometheus/node_exporter/releases/download/v0.14.0/node_exporter-0.14.0.linux-amd64.tar.gz
sudo  tar xvf node_exporter-0.14.0.linux-amd64.tar.gz -C /usr/local/
nohup /usr/local/node_exporter-0.14.0.linux-amd64/node_exporter &amp;
wget https://github.com/prometheus/mysqld_exporter/releases/download/v0.10.0/mysqld_exporter-0.10.0.linux-amd64.tar.gz
sudo tar xvf mysqld_exporter-0.10.0.linux-amd64.tar.gz -C /usr/local/
sudo emacs /usr/local/mysqld_exporter-0.10.0.linux-amd64/.my.cnf
/usr/local/mysqld_exporter-0.10.0.linux-amd64/mysqld_exporter -config.my-cnf=<span style="color: #98be65;">"/usr/local/mysqld_exporter-0.10.0.linux-amd64/.my.cnf"</span> &amp;
</pre>
</div>
</div>
</div>
<div id="outline-container-orgc6a06b5" class="outline-3">
<h3 id="orgc6a06b5"><span class="section-number-3">6.4.</span> 把node_exporter改為service自動執行</h3>
<div class="outline-text-3" id="text-6-4">
<div class="org-src-container">
<pre class="src src-shell">[Unit]
<span style="color: #dcaeea;">Description</span>=Prometheus Node Exporter
<span style="color: #dcaeea;">After</span>=network.target
<span style="color: #dcaeea;">User</span>=prometheus
<span style="color: #dcaeea;">Group</span>=prometheus

[Service]
<span style="color: #dcaeea;">Type</span>=simple
<span style="color: #dcaeea;">Restart</span>=always
<span style="color: #dcaeea;">ExecStart</span>=nohup /usr/local/node_exporter-0.14.0.linux-amd64/node_exporter &amp;

[Install]
<span style="color: #dcaeea;">WantedBy</span>=multi-user.target

</pre>
</div>
<div class="org-src-container">
<pre class="src src-shell">sudo emacs /etc/systemd/system/node_exporter.service
sudo systemctl daemon-reload
sudo systemctl enable node_exporter
sudo systemctl start node_exporter
</pre>
</div>
</div>
</div>
<div id="outline-container-orge69a9be" class="outline-3">
<h3 id="orge69a9be"><span class="section-number-3">6.5.</span> 把mysqld_exporter改為service自動執行</h3>
<div class="outline-text-3" id="text-6-5">
<p>
<a href="https://computingforgeeks.com/install-and-configure-prometheus-mysql-exporter-on-ubuntu-centos/">https://computingforgeeks.com/install-and-configure-prometheus-mysql-exporter-on-ubuntu-centos/</a><br />
mysql_exporter.service<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">[Unit]
<span style="color: #dcaeea;">Description</span>=Prometheus MySQL Exporter
<span style="color: #dcaeea;">After</span>=network.target
<span style="color: #dcaeea;">User</span>=prometheus
<span style="color: #dcaeea;">Group</span>=prometheus

[Service]
<span style="color: #dcaeea;">Type</span>=simple
<span style="color: #dcaeea;">Restart</span>=always
<span style="color: #dcaeea;">ExecStart</span>=/usr/local/mysqld_exporter-0.10.0.linux-amd64/mysqld_exporter -config.my-cnf=<span style="color: #98be65;">"/usr/local/mysqld_exporter-0.10.0.linux-amd64/.my.cnf"</span>

[Install]
<span style="color: #dcaeea;">WantedBy</span>=multi-user.target

</pre>
</div>
<div class="org-src-container">
<pre class="src src-shell">sudo emacs /etc/systemd/system/mysqld_exporter.service
sudo systemctl daemon-reload
sudo systemctl enable mysqld_exporter
sudo systemctl start mysqld_exporter
</pre>
</div>
<p>
安泰 112 2 5 綁約日期<br />
409922  剩餘本金<br />
2.45    目前利率<br />
8000    違約金<br />
月付金不超過2倍，一個月可以還，<br />
</p>

<p>
富邦的每月還款是由台新自動扣款，不要匯到富邦，匯到台新去扣<br />
</p>
</div>
</div>
</div>
<div id="outline-container-org3d30ce8" class="outline-2">
<h2 id="org3d30ce8"><span class="section-number-2">7.</span> Prometheus</h2>
<div class="outline-text-2" id="text-7">
</div>
<div id="outline-container-org94b1b7d" class="outline-3">
<h3 id="org94b1b7d"><span class="section-number-3">7.1.</span> 把node_exporter改為service自動執行</h3>
<div class="outline-text-3" id="text-7-1">
<div class="org-src-container">
<pre class="src src-shell">[Unit]
<span style="color: #dcaeea;">Description</span>=Prometheus Node Exporter
<span style="color: #dcaeea;">After</span>=network.target
<span style="color: #dcaeea;">User</span>=prometheus
<span style="color: #dcaeea;">Group</span>=prometheus

[Service]
<span style="color: #dcaeea;">Type</span>=simple
<span style="color: #dcaeea;">Restart</span>=always
<span style="color: #dcaeea;">ExecStart</span>=nohup /usr/local/node_exporter-0.14.0.linux-amd64/node_exporter &amp;

[Install]
<span style="color: #dcaeea;">WantedBy</span>=multi-user.target

</pre>
</div>
<div class="org-src-container">
<pre class="src src-shell">sudo emacs /etc/systemd/system/node_exporter.service
sudo systemctl daemon-reload
sudo systemctl enable node_exporter
sudo systemctl start node_exporter
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgf14bc03" class="outline-2">
<h2 id="orgf14bc03"><span class="section-number-2">8.</span> phpmyadmin</h2>
<div class="outline-text-2" id="text-8">
<ul class="org-ul">
<li><a href="https://www.webteach.tw/?p=3347">[ Phpmyadmin ] – 透過 Phpmyadmin 一次管理多台遠端資料庫</a><br /></li>
<li><a href="https://lucas-yang.vercel.app/post/local-phpmyadmin-connect-to-remote-mysql/">使用本地 phpMyAdmin 連線到遠端 MySQL 資料庫</a><br /></li>
<li><a href="https://www.itread01.com/content/1542887646.html">配置phpmyadmin連線遠端 MySQL資料庫</a><br /></li>
</ul>
</div>
</div>
<div id="outline-container-org11e6b4d" class="outline-2">
<h2 id="org11e6b4d"><span class="section-number-2">9.</span> Nginx v.s. Moodle</h2>
<div class="outline-text-2" id="text-9">
</div>
<div id="outline-container-org6512a63" class="outline-3">
<h3 id="org6512a63"><span class="section-number-3">9.1.</span> 移除套件</h3>
<div class="outline-text-3" id="text-9-1">
<div class="org-src-container">
<pre class="src src-shell">sudo systemctl stop nginx
sudo apt remove nginx php-fpm php-common php-mysql php-gmp php-curl php-intl php-mbstring php-soap php-gd php-xml php-cli  -y
sudo apt purge nginx php-fpm php-common php-mysql php-gmp php-curl php-intl php-mbstring php-soap php-gd php-xml php-cli  -y
sudo apt autoremove
sudo apt autoclean
</pre>
</div>
</div>
</div>
<div id="outline-container-org3625d91" class="outline-3">
<h3 id="org3625d91"><span class="section-number-3">9.2.</span> 安裝套件</h3>
<div class="outline-text-3" id="text-9-2">
<div class="org-src-container">
<pre class="src src-shell">sudo apt install nginx php-fpm php-common php-mysql php-gmp php-curl php-intl php-mbstring php-soap php-gd php-xml php-cli php-zip unzip git curl -y
</pre>
</div>
</div>
</div>
<div id="outline-container-org17ab607" class="outline-3">
<h3 id="org17ab607"><span class="section-number-3">9.3.</span> 編輯php.ini</h3>
<div class="outline-text-3" id="text-9-3">
<div class="org-src-container">
<pre class="src src-shell">sudo emacs /etc/php/8.0/fpm/php.ini
</pre>
</div>
<p>
更改內容<br />
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #dcaeea;">memory_limit</span> = 256M
cgi.fix_pathinfo = <span style="color: #da8548; font-weight: bold;">0</span>
<span style="color: #dcaeea;">upload_max_filesize</span> = 100M
<span style="color: #dcaeea;">max_execution_time</span> = <span style="color: #da8548; font-weight: bold;">360</span>
date.timezone = <span style="color: #98be65;">"Asia/Taipei"</span>
</pre>
</div>
<p>
重新啟動php<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">sudo systemctl restart php8.0-fpm
</pre>
</div>
</div>
</div>
<div id="outline-container-orgbacea28" class="outline-3">
<h3 id="orgbacea28"><span class="section-number-3">9.4.</span> 安裝Moodle</h3>
<div class="outline-text-3" id="text-9-4">
</div>
<div id="outline-container-org6ddd10b" class="outline-4">
<h4 id="org6ddd10b"><span class="section-number-4">9.4.1.</span> Download</h4>
<div class="outline-text-4" id="text-9-4-1">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #c678dd;">cd</span> /opt
sudo git clone git://git.moodle.org/moodle.git
<span style="color: #c678dd;">cd</span> moodle
sudo git branch -a
sudo git branch --track MOODLE_39_STABLE origin/MOODLE_39_STABLE
sudo git checkout MOODLE_39_STABLE
</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #c678dd;">cd</span> /var/www/html
git clone -b
</pre>
</div>
</div>
</div>
<div id="outline-container-org264dbe3" class="outline-4">
<h4 id="org264dbe3"><span class="section-number-4">9.4.2.</span> 建立目錄</h4>
<div class="outline-text-4" id="text-9-4-2">
<div class="org-src-container">
<pre class="src src-shell">sudo cp -R /opt/moodle /var/www/html/
sudo chown -R www-data:www-data /var/www/html/moodle

sudo mkdir -p /var/www/html/moodledata
sudo chmod -R <span style="color: #da8548; font-weight: bold;">755</span> /var/www/html/*
sudo chown www-data:www-data /var/www/html/moodledata

</pre>
</div>
<p>
GRANT ALL PRIVILEGES ON <b>.</b> TO &rsquo;moodle&rsquo;@&rsquo;%&rsquo; WITH GRANT OPTION;<br />
FLUSH PRIVILEGES;<br />
<a href="https://dotblogs.com.tw/supershowwei/2016/10/23/231423">https://dotblogs.com.tw/supershowwei/2016/10/23/231423</a><br />
</p>
</div>
</div>
<div id="outline-container-org85601fb" class="outline-4">
<h4 id="org85601fb"><span class="section-number-4">9.4.3.</span> 設定Nginx for Moodle</h4>
<div class="outline-text-4" id="text-9-4-3">
<div class="org-src-container">
<pre class="src src-shell">sudo emacs /etc/nginx/conf.d/moodle.conf
</pre>
</div>
<p>
內容<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">server {
    listen <span style="color: #da8548; font-weight: bold;">80</span>;
    root /var/www/html/moodle;
    index  index.php index.html index.htm;
    server_name web;

    client_max_body_size 100M;
    autoindex off;
    location / {
        try_files $<span style="color: #dcaeea;">uri</span> $<span style="color: #dcaeea;">uri</span>/ =<span style="color: #da8548; font-weight: bold;">404</span>;
    }

    location /dataroot/ {
      internal;
      <span style="color: #c678dd;">alias</span> /var/www/html/moodledata/;
    }

    location ~ [^/].php(/|$) {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php7.4-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $<span style="color: #dcaeea;">document_root</span>$<span style="color: #dcaeea;">fastcgi_script_name</span>;
        include fastcgi_params;
    }
}
Save and close the file then verify the Nginx for any syntax error with the following command:
<span style="color: #5B6268;">#</span><span style="color: #5B6268;">+begin_src shell -r :results output :exports both</span>
sudo nginx -t
</pre>
</div>
<p>
#+end_src<br />
restart<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">sudo systemctl restart nginx
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-org4c531bb" class="outline-2">
<h2 id="org4c531bb"><span class="section-number-2">10.</span> Docker commands</h2>
<div class="outline-text-2" id="text-10">
</div>
<div id="outline-container-orgfffcd2f" class="outline-3">
<h3 id="orgfffcd2f"><span class="section-number-3">10.1.</span> List comtainer</h3>
<div class="outline-text-3" id="text-10-1">
<p>
list running containers<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">docker container ls
</pre>
</div>
</div>
</div>
<div id="outline-container-org31a10a3" class="outline-3">
<h3 id="org31a10a3"><span class="section-number-3">10.2.</span> commit</h3>
<div class="outline-text-3" id="text-10-2">
<p>
create a new image <span class="underline">nwImageName</span> from that container<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">docker commit CONTAINER_ID newImageName
</pre>
</div>
</div>
</div>
<div id="outline-container-orgee1a91c" class="outline-3">
<h3 id="orgee1a91c"><span class="section-number-3">10.3.</span> run</h3>
<div class="outline-text-3" id="text-10-3">
<p>
star a container from image<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">docker run newImageName
</pre>
</div>
</div>
</div>
<div id="outline-container-orga81bd42" class="outline-3">
<h3 id="orga81bd42"><span class="section-number-3">10.4.</span> duplicate</h3>
<div class="outline-text-3" id="text-10-4">
<p>
duplicate running container nginix:latest to container <span class="underline">newContainer</span> containing image <span class="underline">newImage</span><br />
</p>
<div class="org-src-container">
<pre class="src src-shell">docker run --name newContainer --volumes-from newImage -d -p 3000:80 nginix:latest
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orge3b69e9" class="outline-2">
<h2 id="orge3b69e9"><span class="section-number-2">11.</span> References</h2>
<div class="outline-text-2" id="text-11">
<ul class="org-ul">
<li><a href="https://stackoverflow.com/questions/49193307/how-to-duplicate-running-docker-container">How to duplicate running docker container</a><br /></li>
<li><a href="https://www.youtube.com/watch?v=mPquwpxyUQU">Docker 10分钟快速入门</a><br /></li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Yung-Chin Yen</p>
<p class="date">Created: 2022-06-01 Wed 13:49</p>
</div>
</body>
</html>
